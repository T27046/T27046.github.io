<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        html, body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
            color: #333;
            overflow-x: hidden;
            overflow-y: hidden;
            height: 100%;
            width: 100%;
            position: fixed;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: #f8fafc;
            position: relative;
            overflow: hidden;
        }



        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }

        .btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            border: none;
        }

        .btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        .btn.primary:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn.secondary {
            background: rgba(255, 255, 255, 0.95);
            color: #667eea;
            border: 2px solid #667eea;
            backdrop-filter: blur(10px);
        }

        .btn.secondary:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-1px);
        }

        /* ‰∏ªÂÜÖÂÆπÂå∫Âüü */
        .main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            overflow: hidden;
            position: relative;
            background: transparent;
            margin: 0;
            border-radius: 0;
            box-shadow: none;
        }

        /* Â∫ïÈÉ®ÊéßÂà∂Èù¢Êùø */
        .bottom-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-top: 1px solid #e2e8f0;
            padding: 20px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 16px;
            align-items: center;
            max-height: 60vh;
            height: 60vh;
            overflow-y: auto;
            transition: height 0.3s ease, max-height 0.3s ease;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.1);
        }

        .bottom-panel.collapsed {
            height: 60px;
            max-height: 60px;
            overflow: hidden;
        }

        .bottom-panel .panel {
            min-width: 300px;
            max-width: 400px;
            margin: 0;
            width: 100%;
            transition: opacity 0.3s ease, transform 0.3s ease;
        }

        .bottom-panel.collapsed .panel {
            opacity: 0;
            transform: translateY(20px);
            pointer-events: none;
        }

        /* Â∫ïÈÉ®Èù¢ÊùøÊî∂Ëµ∑/Â±ïÂºÄÊåâÈíÆ */
        .bottom-panel-toggle {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: 2px solid #ffffff;
            border-bottom: none;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            z-index: 1001;
            box-shadow: 0 -4px 15px rgba(102, 126, 234, 0.4);
            font-weight: 600;
            font-size: 12px;
        }

        .bottom-panel-toggle:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            box-shadow: 0 -6px 20px rgba(102, 126, 234, 0.6);
            transform: translateX(-50%) translateY(-3px);
        }

        .bottom-panel-toggle:active {
            transform: translateX(-50%) translateY(0);
            box-shadow: 0 -2px 8px rgba(102, 126, 234, 0.3);
        }

        .bottom-panel.collapsed .bottom-panel-toggle svg {
            transform: rotate(180deg);
        }

        .bottom-panel-toggle svg {
            transition: transform 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.2));
        }

        /* Êî∂Ëµ∑Áä∂ÊÄÅ‰∏ãÁöÑÊåâÈíÆÊ†∑Âºè */
        .bottom-panel.collapsed .bottom-panel-toggle {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            box-shadow: 0 -4px 15px rgba(76, 175, 80, 0.4);
        }

        .bottom-panel.collapsed .bottom-panel-toggle:hover {
            background: linear-gradient(135deg, #43A047 0%, #3d8b40 100%);
            box-shadow: 0 -6px 20px rgba(76, 175, 80, 0.6);
        }

        /* ‰æßËæπÊ†è */
        .sidebar {
            width: 100%;
            background: #ffffff;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            flex-direction: column;
            overflow-x: auto;
            overflow-y: hidden;
            height: auto;
            max-height: 45vh;
            transition: max-height 0.3s ease;
        }

        .sidebar.collapsed {
            max-height: 0;
            overflow: hidden;
        }

        .panel-container {
            display: flex;
            min-width: max-content;
            padding: 16px 20px;
            gap: 16px;
        }

        .panel {
            background: #ffffff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            border: 1px solid #f1f5f9;
            min-width: 320px;
            flex-shrink: 0;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .panel:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .panel h3 {
            margin-bottom: 16px;
            color: #2c3e50;
            font-size: 18px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .data-info p {
            margin: 8px 0;
            color: #8e8e93;
            font-size: 14px;
        }

        .highlight {
            color: #ff3b30;
            font-weight: 600;
        }

        .route-form {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .search-select-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 16px;
            background: #f8fafc;
        }
        
        .searchable-select-container {
            position: relative;
        }
        
        .searchable-select {
            position: relative;
        }
        
        .searchable-select-input {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid #e8e8e8;
            border-radius: 15px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.95);
            color: #2c3e50;
            transition: all 0.3s ease;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M5 7.5L10 12.5L15 7.5' stroke='%23667eea' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
            background-repeat: no-repeat;

        /* Âõæ‰æãÊ†∑Âºè */
        .legend-container {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 300px;
            max-height: 70vh;
            overflow-y: auto;
            z-index: 100;
            transition: all 0.3s ease;
        }

        .legend-container.collapsed {
            max-height: 40px;
            overflow: hidden;
            padding: 8px 16px;
        }

        .legend-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .legend-title {
            font-size: 16px;
            font-weight: 600;
            color: #2c3e50;
            margin: 0;
        }

        .legend-toggle {
            background: none;
            border: none;
            font-size: 18px;
            color: #667eea;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .legend-toggle:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .legend-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .legend-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 8px;
            border-radius: 8px;
            transition: background-color 0.2s ease;
        }

        .legend-item:hover {
            background: rgba(102, 126, 234, 0.05);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .legend-info {
            flex: 1;
            min-width: 0;
        }

        .legend-line-name {
            font-size: 14px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 2px;
        }

        .legend-line-details {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        .legend-line-type {
            display: inline-block;
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 500;
            margin-right: 6px;
        }

        .legend-stations {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }

        /* Âõæ‰æãÁº©ÊîæÈÄÇÈÖç */
        @media (max-width: 768px) {
            .legend-container {
                top: 10px;
                right: 10px;
                max-width: 250px;
            }
        }
            background-position: right 16px center;
            background-size: 16px;
            backdrop-filter: blur(10px);
        }
        
        .searchable-select-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background-color: white;
        }
        
        .searchable-select-input:hover {
            border-color: #b8c2cc;
        }
        
        .searchable-select-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #c6c6c8;
            border-top: none;
            border-radius: 0 0 10px 10px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
        }
        
        .searchable-select-option {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f2f2f7;
            transition: background-color 0.2s ease;
        }
        
        .searchable-select-option:hover {
            background-color: #f2f2f7;
        }
        
        .searchable-select-option:last-child {
            border-bottom: none;
        }

        .station-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #c6c6c8;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M5 7.5L10 12.5L15 7.5' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            margin-bottom: 8px;
        }

        .station-select:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .strategy-select {
            width: 100%;
            padding: 12px;
            border: 1px solid #c6c6c8;
            border-radius: 10px;
            font-size: 16px;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml;charset=US-ASCII,<svg width='20' height='20' viewBox='0 0 20 20' fill='none' xmlns='http://www.w3.org/2000/svg'><path d='M5 7.5L10 12.5L15 7.5' stroke='%238e8e93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/></svg>");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            margin-bottom: 8px;
        }
        
        .strategy-select:focus {
            outline: none;
            border-color: #007AFF;
        }
        
        .route-options {
            margin: 15px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }
        
        .route-options label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
        }



        .route-info, .transfer-info {
            margin-top: 12px;
            max-height: 120px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.4;
            color: #8e8e93;
        }

        .transfer-step {
            background: #f2f2f7;
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #007AFF;
        }

        .transfer-step .line-name {
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 14px;
        }

        .transfer-step .stations {
            color: #8e8e93;
            font-size: 13px;
        }

        /* Âú∞ÂõæÂÆπÂô® */
        .map-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #f8f9fa;
            touch-action: none;
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
        }

        #mapCanvas {
            width: 100%;
            height: 100%;
            display: block;
            cursor: grab;
        }

        #mapCanvas:active {
            cursor: grabbing;
        }

        .map-controls {
            position: absolute;
            top: 24px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            z-index: 1000;
        }

        .map-btn {
            width: 56px;
            height: 56px;
            border: none;
            border-radius: 28px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            cursor: pointer;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            color: white;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .map-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(102, 126, 234, 0.6);
        }

        .map-btn:active {
            transform: translateY(0);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        /* Á´ôÂêçÊ†áÁ≠æÊ†∑Âºè */
        .station-label {
            position: absolute;
            background: none;
            padding: 0;
            border: none;
            font-size: 12px;
            font-weight: 600;
            color: #000000; /* ÈªëËâ≤ÊñáÂ≠ó */
            white-space: nowrap;
            box-shadow: none;
            /*text-shadow: 0 0 8px rgba(255, 255, 255, 0.8), 0 0 16px rgba(255, 255, 255, 0.6);*/
            backdrop-filter: none;
            pointer-events: none;
            z-index: 100;
            transform: translate(-50%, -100%);
        }
        
        /* ÂèåËØ≠Á´ôÂêçÊ†∑Âºè */
        .station-name-chinese {
            background: none;
            padding: 0;
            border: none;
            font-size: 11px;
            font-weight: bold;
            color: #000000; /* ÈªëËâ≤ÊñáÂ≠ó */
            white-space: nowrap;
            box-shadow: none;
            /*text-shadow: 0 0 6px rgba(255, 255, 255, 0.8), 0 0 12px rgba(255, 255, 255, 0.6);*/
            backdrop-filter: none;
            margin-bottom: 1px;
        }
        
        .station-name-english {
            background: none;
            padding: 0;
            border: none;
            font-size: 9px;
            font-weight: normal;
            color: #333333; /* Ê∑±ÁÅ∞Ëâ≤ */
            white-space: nowrap;
            box-shadow: none;
            /*text-shadow: 0 0 4px rgba(255, 255, 255, 0.8), 0 0 8px rgba(255, 255, 255, 0.6); */
            backdrop-filter: none;
        }
        
        /* Êç¢‰πò‰ø°ÊÅØÊ†∑Âºè */
        .station-transfer-info {
            margin-top: 2px;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            color: #000000; /* ÈªëËâ≤ÊñáÂ≠ó */
            /*text-shadow: 0 0 4px rgba(255, 255, 255, 0.8), 0 0 8px rgba(255, 255, 255, 0.6);*/
            border: 1px solid #e0e0e0;
            font-size: 8px;
            line-height: 1.2;
        }
        
        .transfer-lines {
            color: #007AFF;
            font-weight: bold;
        }
        
        .transfer-platforms {
            color: #666666;
            font-size: 7px;
        }



        /* ÁßªÂä®Á´Ø‰ºòÂåñ - È´òÂæ∑Âú∞ÂõæÈ£éÊ†º */
        @media (max-width: 768px) {
            
            .btn {
                padding: 5px 8px;
                font-size: 11px;
                min-height: 30px;
                border-radius: 6px;
            }
            
            .btn.primary {
                background: linear-gradient(135deg, #1E90FF, #007AFF);
            }
            
            .btn.secondary {
                background: rgba(255, 255, 255, 0.9);
                color: #007AFF;
                border: 1px solid rgba(30, 144, 255, 0.3);
            }
            
            .sidebar {
                max-height: 35vh;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-bottom: 1px solid rgba(30, 144, 255, 0.3);
            }
            
            .panel-container {
                padding: 6px 10px;
                gap: 6px;
            }
            
            .panel {
                padding: 10px;
                min-width: 260px;
                background: rgba(255, 255, 255, 0.95);
                border: 1px solid rgba(30, 144, 255, 0.15);
                box-shadow: 0 4px 12px rgba(30, 144, 255, 0.1);
            }
            
            .panel h3 {
                font-size: 13px;
                margin-bottom: 6px;
                color: #007AFF;
            }
            
            .station-select {
                padding: 8px;
                font-size: 12px;
                border: 1px solid rgba(30, 144, 255, 0.2);
            }
            
            .map-container {
                background: #f8f9fa;
            }
            
            .map-btn {
                width: 44px;
                height: 44px;
                font-size: 18px;
                background: linear-gradient(135deg, #1E90FF, #007AFF);
                box-shadow: 0 4px 12px rgba(30, 144, 255, 0.3);
            }
            
            .map-controls {
                top: 16px;
                right: 12px;
                gap: 4px;
            }
            
            .station-label {
                background: none;
                border: none;
                font-size: 9px;
                padding: 0;
            }
        }

        /* Â∞èÂ±èÂπïÊâãÊú∫‰ºòÂåñ - È´òÂæ∑Âú∞ÂõæÈ£éÊ†º */
        @media (max-width: 480px) {
            
            .btn {
                padding: 4px 6px;
                font-size: 10px;
                min-height: 28px;
                border-radius: 4px;
            }
            
            .sidebar {
                max-height: 28vh;
            }
            
            .panel-container {
                padding: 4px 8px;
                gap: 4px;
            }
            
            .panel {
                padding: 8px;
                min-width: 220px;
            }
            
            .panel h3 {
                font-size: 12px;
                margin-bottom: 4px;
            }
            
            .station-select {
                padding: 6px;
                font-size: 11px;
            }
            
            .map-container {
                height: 72vh;
            }
            
            .map-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }
            
            .map-controls {
                top: 12px;
                right: 8px;
            }
            
            .station-label {
                font-size: 8px;
                padding: 0;
                background: none;
                border: none;
                box-shadow: none;
                text-shadow: none;
            }
            
            .notification {
                top: 10px;
                right: 10px;
                padding: 0.8rem 1.2rem;
                font-size: 12px;
            }
        }

        /* ÈÄöÁü•Ê†∑Âºè */
        .notification {
            position: fixed;
            top: 24px;
            right: 24px;
            padding: 20px 24px;
            border-radius: 16px;
            color: white;
            z-index: 10000;
            animation: slideIn 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            box-shadow: 0 12px 40px rgba(0,0,0,0.2);
            font-weight: 600;
            font-size: 15px;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            max-width: 400px;
        }

        .notification.success {
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.9) 0%, rgba(46, 204, 113, 0.9) 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, rgba(231, 76, 60, 0.9) 0%, rgba(192, 57, 43, 0.9) 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">

        <!-- ‰∏ªÂÜÖÂÆπÂå∫Âüü -->
        <main class="main-content">
            <!-- Âú∞ÂõæÂå∫Âüü -->
            <div class="map-container">
                <canvas id="mapCanvas"></canvas>
                <!-- Âõæ‰æãÂÆπÂô® -->
                <div class="legend-container" id="legendContainer">
                    <div class="legend-header" onclick="mapRenderer.toggleLegend()">
                        <h3 class="legend-title">Á∫øË∑ØÂõæ‰æã</h3>
                        <button class="legend-toggle" title="Â±ïÂºÄ/Êî∂Ëµ∑Âõæ‰æã">‚ñº</button>
                    </div>
                    <div class="legend-content" id="legendContent">
                        <!-- Âõæ‰æãÂÜÖÂÆπÂ∞ÜÈÄöËøáJavaScriptÂä®ÊÄÅÁîüÊàê -->
                    </div>
                </div>
                <div class="map-controls">
                    <button id="zoomIn" class="map-btn" title="ÊîæÂ§ß">+</button>
                    <button id="zoomOut" class="map-btn" title="Áº©Â∞è">-</button>
                    <button id="resetView" class="map-btn" title="ÈáçÁΩÆËßÜÂõæ">‚Ü∫</button>
                    <button id="saveImage" class="map-btn" title="‰øùÂ≠òÂõæÁâá">üì∑</button>
                </div>
            </div>

            <!-- Â∫ïÈÉ®ÊéßÂà∂Èù¢Êùø -->
            <div class="bottom-panel">
                <!-- Êî∂Ëµ∑/Â±ïÂºÄÊåâÈíÆ -->
                <div class="bottom-panel-toggle" onclick="utils.toggleBottomPanel()">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M5 7.5L10 12.5L15 7.5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                
                <div class="panel">
                    <h3>Á´ôÁÇπÈÄâÊã©</h3>
                    <div class="route-form">
                        <!-- ÂèØÊêúÁ¥¢‰∏ãÊãâÊ°ÜÁªÑÂêà -->
                        <div class="search-select-group">
                            <div class="searchable-select-container">
                                <div class="searchable-select" data-for="startStation">
                                    <input type="text" class="searchable-select-input" placeholder="ÊêúÁ¥¢Ëµ∑ÁÇπÁ´ô...">
                                    <div class="searchable-select-options" id="startStationOptions"></div>
                                </div>
                                <select id="startStation" class="station-select" style="display: none;">
                                    <option value="">ÈÄâÊã©Ëµ∑ÁÇπÁ´ô</option>
                                </select>
                            </div>
                            
                            <div class="searchable-select-container">
                                <div class="searchable-select" data-for="endStation">
                                    <input type="text" class="searchable-select-input" placeholder="ÊêúÁ¥¢ÁªàÁÇπÁ´ô...">
                                    <div class="searchable-select-options" id="endStationOptions"></div>
                                </div>
                                <select id="endStation" class="station-select" style="display: none;">
                                    <option value="">ÈÄâÊã©ÁªàÁÇπÁ´ô</option>
                                </select>
                            </div>
                        </div>
                        
                        <button id="calculateRoute" class="btn primary">ËÆ°ÁÆóË∑ØÂæÑ</button>
                    </div>
                    <div id="routeInfo" class="route-info">
                        <p>ËØ∑ÈÄâÊã©Ëµ∑ÁÇπÂíåÁªàÁÇπÁ´ôËøõË°åË∑ØÂæÑËßÑÂàí</p>
                    </div>
                </div>
                
                <div class="panel">
                    <h3>Êç¢‰πò‰ø°ÊÅØ</h3>
                    <div id="transferInfo" class="transfer-info">
                        <p>Ë∑ØÂæÑËßÑÂàíÂÆåÊàêÂêéÊòæÁ§∫Êç¢‰πò‰ø°ÊÅØ</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // Â∫îÁî®Áä∂ÊÄÅ
        const appState = {
            canvas: null,
            ctx: null,
            stations: [],
            lines: [],
            graph: null,
            mapScale: 1,
            mapOffset: { x: 0, y: 0 },
            isDragging: false,
            lastMousePos: { x: 0, y: 0 },
            isPinching: false,
            lastTouchPos: { x: 0, y: 0 },
            lastTouchDistance: 0,
            stationLabels: [],
            // Êñ∞Â¢ûÔºöËäÇÁÇπËΩ¨ÊäòÁÇπÁÆ°ÁêÜÔºàÂÉèÁ´ôÁÇπ‰∏ÄÊ†∑Â≠òÂÇ®Ôºâ
            nodes: []
        };

        // Â∑•ÂÖ∑ÂáΩÊï∞
        const utils = {
            showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            },

            // ÁßªÂä®Á´Ø‰æßËæπÊ†èÊäòÂè†ÂäüËÉΩ
        toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('collapsed');
        },

        // Ê£ÄÊµãÊòØÂê¶‰∏∫ÁßªÂä®ËÆæÂ§áÔºàÂü∫‰∫éÊòæÁ§∫Âå∫ÂüüÂ∞∫ÂØ∏Ôºâ
        isMobileDevice() {
            return window.innerWidth <= 768;
        },

        // Â∫ïÈÉ®Èù¢ÊùøÊî∂Ëµ∑/Â±ïÂºÄÂäüËÉΩ
        toggleBottomPanel() {
            const bottomPanel = document.querySelector('.bottom-panel');
            const toggleButton = document.querySelector('.bottom-panel-toggle');
            const isCollapsed = bottomPanel.classList.toggle('collapsed');
            
            // Êõ¥Êñ∞ÊåâÈíÆÊèêÁ§∫ÊñáÊú¨
            if (isCollapsed) {
                toggleButton.setAttribute('title', 'Â±ïÂºÄÈù¢Êùø');
                toggleButton.setAttribute('aria-label', 'Â±ïÂºÄÂ∫ïÈÉ®Èù¢Êùø');
                // Ê∑ªÂä†Êî∂Ëµ∑Áä∂ÊÄÅÊåáÁ§∫
                this.showNotification('Â∫ïÈÉ®Èù¢ÊùøÂ∑≤Êî∂Ëµ∑', 'success');
            } else {
                toggleButton.setAttribute('title', 'Êî∂Ëµ∑Èù¢Êùø');
                toggleButton.setAttribute('aria-label', 'Êî∂Ëµ∑Â∫ïÈÉ®Èù¢Êùø');
                // Ê∑ªÂä†Â±ïÂºÄÁä∂ÊÄÅÊåáÁ§∫
                this.showNotification('Â∫ïÈÉ®Èù¢ÊùøÂ∑≤Â±ïÂºÄ', 'success');
            }
        },

            parseCSV(csvText) {
                const lines = csvText.trim().split('\n');
                const headers = lines[0].split(',').map(h => h.trim());
                const data = [];
                
                for (let i = 1; i < lines.length; i++) {
                    // ÊîπËøõÁöÑCSVËß£ÊûêÔºåÂ§ÑÁêÜÂåÖÂê´ÈÄóÂè∑ÁöÑÂºïÂè∑Â≠óÊÆµ
                    const line = lines[i];
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < line.length; j++) {
                        const char = line[j];
                        
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim()); // Ê∑ªÂä†ÊúÄÂêé‰∏Ä‰∏™Â≠óÊÆµ
                    
                    // ÁßªÈô§Â≠óÊÆµÂÄº‰∏≠ÁöÑÂºïÂè∑
                    const cleanedValues = values.map(v => v.replace(/^"/, '').replace(/"$/, ''));
                    
                    if (cleanedValues.length === headers.length) {
                        const item = {};
                        headers.forEach((header, index) => {
                            item[header] = cleanedValues[index];
                        });
                        data.push(item);
                    }
                }
                return data;
            },

            parseJSON(jsonText) {
                try {
                    return JSON.parse(jsonText);
                } catch (error) {
                    throw new Error('JSONÊ†ºÂºèÈîôËØØ');
                }
            },

            calculateDistance(x1, y1, x2, y2) {
                // ‰ΩøÁî®Ê¨ßÂá†ÈáåÂæóË∑ùÁ¶ªÂÖ¨ÂºèËÆ°ÁÆó‰∏§ÁÇπ‰πãÈó¥ÁöÑË∑ùÁ¶ªÔºàÂçï‰ΩçÔºöÁ±≥Ôºâ
                const dx = x2 - x1;
                const dy = y2 - y1;
                return Math.sqrt(dx * dx + dy * dy);
            }
        };

        // Êï∞ÊçÆÂ§ÑÁêÜÂáΩÊï∞
        const dataProcessor = {
            parseCSVData(csvText) {
                const data = utils.parseCSV(csvText);
                
                // ÊåâÁ∫øË∑ØÂàÜÁªÑÁ´ôÁÇπÊï∞ÊçÆ
                const linesMap = new Map();
                
                data.forEach(item => {
                    const lineId = item.line || '1';
                    const lineName = item.lineName || `Á∫øË∑Ø${lineId}`;
                    
                    if (!linesMap.has(lineId)) {
                        linesMap.set(lineId, {
                            id: lineId,
                            name: lineName,
                            color: this.getLineColor(lineId),
                            stations: []
                        });
                    }
                    
                    const station = {
                        name: item.name || item.station || '',
                        englishName: item.englishName || item.english_name || item.name || '',
                        latitude: parseFloat(item.latitude || item.lat || 0),
                        longitude: parseFloat(item.longitude || item.lng || item.lon || 0),
                        line: lineId,
                        sequence: parseInt(item.sequence) || 0,
                        transfer: item.transfer === 'true' || item.transfer === 'TRUE' || item.transfer === true,
                        transferLines: item.transferLines ? item.transferLines.split(',').map(line => line.trim()) : [],
                        transferPlatforms: item.transferPlatforms ? item.transferPlatforms.split(',').map(platform => platform.trim()) : []
                    };
                    
                    if (station.name && !isNaN(station.latitude) && !isNaN(station.longitude)) {
                        linesMap.get(lineId).stations.push(station);
                    }
                });
                
                // ÂØπÊØèÊù°Á∫øË∑ØÁöÑÁ´ôÁÇπÊåâsequenceÊéíÂ∫è
                linesMap.forEach(line => {
                    line.stations.sort((a, b) => a.sequence - b.sequence);
                });
                
                return {
                    lines: Array.from(linesMap.values()),
                    stations: Array.from(linesMap.values()).flatMap(line => line.stations)
                };
            },
            
            getLineColor(lineId) {
                const colors = {
                    '1': '#FF0000',        // Á∫¢Ëâ≤
                    '2': '#0000FF',        // ËìùËâ≤
                    '3': '#00FF00',        // ÁªøËâ≤
                    '4': '#FFA500',        // Ê©ôËâ≤
                    '5': '#800080',        // Á¥´Ëâ≤
                    '6': '#FFC0CB',        // Á≤âËâ≤
                    '7': '#A52A2A',        // Ê£ïËâ≤
                    '8': '#808080',        // ÁÅ∞Ëâ≤
                    '9': '#FFFF00',        // ÈªÑËâ≤
                    '10': '#00FFFF',       // ÈùíËâ≤
                    'N1': '#E3002B',       // Ê∑±Á∫¢Ëâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'N2': '#8A2BE2',      // ËìùÁ¥´Ëâ≤
                    'N3': '#FF4500',      // Ê©ôÁ∫¢Ëâ≤
                    'K1': '#53c700',      // ÁªøËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'K2': '#005eff',      // ËìùËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'ËøëË•øÂçóÁ∫ø': '#ffd500', // ÈáëËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'ÂåóÊ°•Á∫ø': '#ff8fa4',   // Á≤âËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S1': '#00c3ff',      // Â§©ËìùËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S2': '#00ffaa',      // ÈùíÁªøËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S3': '#fcba77',      // ÊµÖÊ©ôËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S4': '#ff5900',      // Ê©ôËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S5': '#b7ff00',      // ÈªÑÁªøËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                    'S6': '#b7ff00'       // ÈªÑÁªøËâ≤ÔºàÊù•Ëá™Êï∞ÊçÆÊñá‰ª∂Ôºâ
                };
                return colors[lineId] || '#000000'; // ÈªòËÆ§ÈªëËâ≤
            },

            // ËäÇÁÇπÊï∞ÊçÆÁªìÊûÑ
            Node: class {
                constructor(id, name, X, Y, type = 'turn') {
                    this.id = id;
                    this.name = name;
                    this.X = X;
                    this.Y = Y;
                    this.type = type; // 'turn': ËΩ¨ÊäòÁÇπ, 'station': Á´ôÁÇπ
                    this.connectedLines = [];
                }
            },

            // Ëß£ÊûêËäÇÁÇπÊï∞ÊçÆÔºàÈÄÇÈÖçÊÇ®ÁöÑCSVÊ†ºÂºèÔºöx,y,line,stn1,stn2Ôºâ
            parseNodeData(nodeData) {
                const nodes = [];
                const rows = nodeData.trim().split('\n');
                
                // Ë∑≥ËøáÁ©∫Ë°å
                const nonEmptyRows = rows.filter(row => row.trim());
                if (nonEmptyRows.length < 2) return nodes; // Ëá≥Â∞ëÈúÄË¶ÅÊ†áÈ¢òË°åÂíå‰∏ÄË°åÊï∞ÊçÆ
                
                const headers = nonEmptyRows[0].split(',').map(h => h.trim());
                
                for (let i = 1; i < nonEmptyRows.length; i++) {
                    const row = nonEmptyRows[i].trim();
                    if (!row) continue;
                    
                    const values = row.split(',').map(v => v.trim());
                    
                    if (values.length === headers.length) {
                        const nodeInfo = {};
                        headers.forEach((header, index) => {
                            nodeInfo[header] = values[index];
                        });
                        
                        // Ê†πÊçÆÊÇ®ÁöÑCSVÊ†ºÂºèÂàõÂª∫ËäÇÁÇπÔºà‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÔºâ
                        const node = {
                            id: `node_${nodes.length + 1}`,
                            name: `${nodeInfo.stn1}_${nodeInfo.stn2}_ËäÇÁÇπ`,
                            X: parseFloat(nodeInfo.x),
                            Y: parseFloat(nodeInfo.y),
                            type: 'node', // ÁâπÊÆäÁ±ªÂûãÔºöËäÇÁÇπ
                            line: nodeInfo.line,
                            stn1: nodeInfo.stn1,
                            stn2: nodeInfo.stn2,
                            englishName: `${nodeInfo.stn1}_${nodeInfo.stn2}_Node`,
                            lineName: nodeInfo.line
                        };
                        
                        nodes.push(node);
                    }
                }
                
                return nodes;
            },

            parseJSONData(jsonText) {
                const data = utils.parseJSON(jsonText);
                if (Array.isArray(data)) {
                    return data.map(item => ({
                        name: item.name || item.station || '',
                        latitude: parseFloat(item.latitude || item.lat || 0),
                        longitude: parseFloat(item.longitude || item.lng || item.lon || 0),
                        line: item.line || '1',
                        lineName: item.lineName || `Á∫øË∑Ø${item.line || '1'}`
                    })).filter(station => station.name && !isNaN(station.latitude) && !isNaN(station.longitude));
                }
                return [];
            },

            groupStationsByLine(stations) {
                const linesMap = new Map();
                
                stations.forEach(station => {
                    if (!linesMap.has(station.line)) {
                        linesMap.set(station.line, {
                            id: station.line,
                            name: station.lineName,
                            color: this.getLineColor(station.line),
                            stations: []
                        });
                    }
                    linesMap.get(station.line).stations.push(station);
                });
                
                // ÊåâÁ´ôÁÇπÈ°∫Â∫èÊéíÂ∫èÔºåÊîØÊåÅsequenceList
                linesMap.forEach(line => {
                    line.stations.sort((a, b) => {
                        // ‰ºòÂÖà‰ΩøÁî®sequenceList‰∏≠ÂØπÂ∫îÁ∫øË∑ØÁöÑÈ°∫Â∫è
                        const aSeqList = a.sequenceList || [a.sequence];
                        const bSeqList = b.sequenceList || [b.sequence];
                        
                        // ‰ΩøÁî®Á¨¨‰∏Ä‰∏™ÊúâÊïàÁöÑÂ∫èÂàóÂÄºËøõË°åÊéíÂ∫è
                        const aSeq = aSeqList.length > 0 ? aSeqList[0] : a.sequence;
                        const bSeq = bSeqList.length > 0 ? bSeqList[0] : b.sequence;
                        
                        return aSeq - bSeq;
                    });
                });
                
                return Array.from(linesMap.values());
            },



            parseLineData(lineData) {
                const lines = [];
                const rows = lineData.trim().split('\n');
                const headers = rows[0].split(',');
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row.trim()) continue;
                    
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < row.length; j++) {
                        const char = row[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    if (values.length === headers.length) {
                        const line = {};
                        headers.forEach((header, index) => {
                            line[header] = values[index];
                        });
                        lines.push(line);
                    }
                }
                
                return lines;
            },

            parseStationData(stationData) {
                const stations = [];
                const rows = stationData.trim().split('\n');
                const headers = rows[0].split(',');
                
                for (let i = 1; i < rows.length; i++) {
                    const row = rows[i];
                    if (!row.trim()) continue;
                    
                    const values = [];
                    let current = '';
                    let inQuotes = false;
                    
                    for (let j = 0; j < row.length; j++) {
                        const char = row[j];
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(current.trim());
                            current = '';
                        } else {
                            current += char;
                        }
                    }
                    values.push(current.trim());
                    
                    if (values.length === headers.length) {
                        const station = {};
                        headers.forEach((header, index) => {
                            station[header] = values[index];
                        });
                        stations.push(station);
                    }
                }
                
                return stations;
            },

            combineLineAndStationData(linesData, stationsData) {
                const lines = [];
                const stations = [];
                
                // Â§ÑÁêÜÊØèÊù°Á∫øË∑Ø
                linesData.forEach((lineInfo, index) => {
                    // ÁîüÊàêÈªòËÆ§ÁöÑÁ∫øË∑ØIDÂíåÂêçÁß∞ÔºàÂØπ‰∫éÊ≤°ÊúâlineIdÂíålineNameÁöÑÊ≠•Ë°åË∑ØÁ∫øË∑ØÔºâ
                    const lineId = lineInfo.lineId || `W${index + 1}`;
                    const lineName = lineInfo.lineName || 'Ê≠•Ë°åË∑Ø';
                    
                    const line = {
                        id: lineId,
                        name: lineName,
                        color: lineInfo.color,
                        isExpress: lineInfo.isExpress === 'true',
                        lineType: lineInfo.lineType || 'subway', // ÈªòËÆ§Âú∞ÈìÅÁ±ªÂûã
                        stations: [],
                        branches: {} // Â≠òÂÇ®ÊîØÁ∫ø‰ø°ÊÅØ
                    };
                    
                    // Ëß£ÊûêÁ´ôÁÇπÂ∫èÂàóÔºàÊîØÊåÅÊîØÁ∫øÊ†ºÂºèÔºâ
                    if (lineInfo.stationSequence) {
                        // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ÊîØÁ∫øÂàÜÈöîÁ¨¶
                        if (lineInfo.stationSequence.includes('|')) {
                            // Ëß£ÊûêÊîØÁ∫øÊ†ºÂºè
                            const parts = lineInfo.stationSequence.split('|');
                            
                            // ‰∏ªÁ∫øË∑ØÈÉ®ÂàÜÔºàÁ¨¨‰∏Ä‰∏™ÈÉ®ÂàÜÔºâ
                            const mainLinePart = parts[0].trim();
                            this.parseStationSequence(mainLinePart, line, stations, stationsData, 'main');
                            
                            // ÊîØÁ∫øÈÉ®ÂàÜÔºàÂêéÁª≠ÈÉ®ÂàÜÔºâ
                            for (let i = 1; i < parts.length; i++) {
                                const branchPart = parts[i].trim();
                                if (branchPart.includes(':')) {
                                    const [branchName, branchStations] = branchPart.split(':');
                                    if (branchName && branchStations) {
                                        const branchLine = {
                                            id: `${lineId}_${branchName.trim()}`,
                                            name: `${lineName} ${branchName.trim()}`,
                                            color: lineInfo.color,
                                            isExpress: lineInfo.isExpress === 'true',
                                            lineType: lineInfo.lineType || 'subway',
                                            stations: [],
                                            branchOf: lineId,
                                            branchName: branchName.trim()
                                        };
                                        
                                        this.parseStationSequence(branchStations.trim(), branchLine, stations, stationsData, branchName.trim());
                                        
                                        // Â∞ÜÊîØÁ∫øÊ∑ªÂä†Âà∞‰∏ªÁ∫øË∑ØÁöÑbranchesÂØπË±°‰∏≠
                                        if (!line.branches) line.branches = {};
                                        line.branches[branchName.trim()] = branchLine;
                                        
                                        // Â∞ÜÊîØÁ∫øÊ∑ªÂä†Âà∞Á∫øË∑ØÂàóË°®‰∏≠
                                        lines.push(branchLine);
                                    }
                                }
                            }
                        } else {
                            // ‰º†ÁªüÊ†ºÂºèÔºàÊó†ÊîØÁ∫øÔºâ
                            this.parseStationSequence(lineInfo.stationSequence, line, stations, stationsData, 'main');
                        }
                    }
                    
                    // ÊåâÂ∫èÂàóÂè∑ÊéíÂ∫èÁ´ôÁÇπ
                    line.stations.sort((a, b) => a.sequence - b.sequence);
                    lines.push(line);
                });
                
                return { lines, stations };
            },
            
            // Ëß£ÊûêÁ´ôÁÇπÂ∫èÂàóÁöÑËæÖÂä©ÂáΩÊï∞
            parseStationSequence(sequenceString, line, stations, stationsData, branchType) {
                const stationPairs = sequenceString.split(',');
                stationPairs.forEach(pair => {
                    const [stationName, sequence] = pair.split(':');
                    if (stationName && sequence) {
                        // Êü•ÊâæÁ´ôÁÇπ‰ø°ÊÅØ
                        const stationInfo = stationsData.find(s => s.name === stationName.trim());
                        if (stationInfo) {
                            const station = {
                                name: stationInfo.name,
                                englishName: stationInfo.englishName,
                                X: parseFloat(stationInfo.X),
                                Y: parseFloat(stationInfo.Y),
                                line: line.id,
                                lineName: line.name,
                                sequence: parseInt(sequence),
                                transfer: stationInfo.transfer === 'true',
                                transferLines: stationInfo.transferLines ? stationInfo.transferLines.split(',') : [],
                                transferPlatforms: stationInfo.transferPlatforms ? stationInfo.transferPlatforms.split(',') : [],
                                isMajor: stationInfo.isMajor === 'true',
                                management: stationInfo.management || '',
                                branch: branchType // Ê†áËÆ∞ÊâÄÂ±ûÊîØÁ∫ø
                            };
                            line.stations.push(station);
                            stations.push(station);
                        }
                    }
                });
            },

            // Â∞ÜËäÇÁÇπÊèíÂÖ•Âà∞Á∫øË∑ØÁ´ôÁÇπÂ∫èÂàó‰∏≠
            insertNodesIntoLineSequences(lines, nodes) {
                nodes.forEach(node => {
                    // ÊâæÂà∞ËäÇÁÇπÊâÄÂ±ûÁöÑÁ∫øË∑Ø
                    const targetLine = lines.find(line => line.id === node.line);
                    if (!targetLine) return;
                    
                    // ÊâæÂà∞ËäÇÁÇπÂâçÂêéÁöÑÁ´ôÁÇπ
                    const stn1Index = targetLine.stations.findIndex(station => station.name === node.stn1);
                    const stn2Index = targetLine.stations.findIndex(station => station.name === node.stn2);
                    
                    // Á°Æ‰øù‰∏§‰∏™Á´ôÁÇπÈÉΩÂ≠òÂú®‰∏îÁõ∏ÈÇª
                    if (stn1Index !== -1 && stn2Index !== -1 && Math.abs(stn1Index - stn2Index) === 1) {
                        // Á°ÆÂÆöÊèíÂÖ•‰ΩçÁΩÆÔºàÂú®stn1Âíåstn2‰πãÈó¥Ôºâ
                        const insertIndex = Math.max(stn1Index, stn2Index);
                        
                        // ËÆ°ÁÆóÊèíÂÖ•ËäÇÁÇπÁöÑÂ∫èÂàóÂè∑ÔºàÂèñÂâçÂêéÁ´ôÁÇπÁöÑÂπ≥ÂùáÂÄºÔºâ
                        const prevStation = targetLine.stations[insertIndex - 1];
                        const nextStation = targetLine.stations[insertIndex];
                        const nodeSequence = (prevStation.sequence + nextStation.sequence) / 2;
                        
                        // ÂàõÂª∫ËäÇÁÇπÁ´ôÁÇπÂØπË±°
                        const nodeStation = {
                            name: node.name,
                            englishName: node.englishName,
                            X: node.X,
                            Y: node.Y,
                            line: node.line,
                            lineName: node.lineName,
                            sequence: nodeSequence,
                            transfer: false,
                            transferLines: [],
                            transferPlatforms: [],
                            isMajor: false,
                            management: '',
                            type: 'node' // Ê†áËÆ∞‰∏∫ËäÇÁÇπÁ±ªÂûã
                        };
                        
                        // ÊèíÂÖ•ËäÇÁÇπÂà∞Á∫øË∑ØÁ´ôÁÇπÂ∫èÂàó
                        targetLine.stations.splice(insertIndex, 0, nodeStation);
                        
                        console.log(`Âú®Á∫øË∑Ø ${node.line} ÁöÑ ${node.stn1} Âíå ${node.stn2} ‰πãÈó¥ÊèíÂÖ•ËäÇÁÇπ ${node.name}`);
                    }
                });
                
                // ÈáçÊñ∞ÊéíÂ∫èÊâÄÊúâÁ∫øË∑ØÁöÑÁ´ôÁÇπ
                lines.forEach(line => {
                    line.stations.sort((a, b) => a.sequence - b.sequence);
                });
                
                return lines;
            }
        };

        // Ë∑ØÂæÑËßÑÂàíÁÆóÊ≥ï
        const routePlanner = {
            buildGraph(lines) {
                const graph = {};
                
                // È¶ñÂÖàÊî∂ÈõÜÊâÄÊúâÁ´ôÁÇπÔºàÂåÖÂê´Ê≠•Ë°åË∑ØÁ∫øË∑ØÔºâ
                const allStations = [];
                lines.forEach(line => {
                    allStations.push(...line.stations);
                });
                
                // ËøûÊé•Âêå‰∏ÄÊù°Á∫øË∑Ø‰∏äÁöÑÁõ∏ÈÇªÁ´ôÁÇπÔºàÂåÖÂê´Ê≠•Ë°åË∑ØÁ∫øË∑ØÔºâ
                // Âè™ËøûÊé•Ëá≥Â∞ëÂåÖÂê´2‰∏™Á´ôÁÇπÁöÑÁ∫øË∑ØÔºåÁ°Æ‰øùÁî®Êà∑ËÉΩÂ§ü‰πòÂùêËØ•Á∫øË∑ØÂà∞Âè¶‰∏ÄÁ´ô
                lines.forEach(line => {
                    // Â¶ÇÊûúÁ∫øË∑ØÁ´ôÁÇπÊï∞ÈáèÂ∞ë‰∫é2‰∏™ÔºåË∑≥ËøáËØ•Á∫øË∑ØÔºàÁî®Êà∑Êó†Ê≥ï‰πòÂùêËØ•Á∫øË∑ØÂà∞Âè¶‰∏ÄÁ´ôÔºâ
                    if (line.stations.length < 2) {
                        return;
                    }
                    
                    const stations = line.stations;
                    for (let i = 0; i < stations.length - 1; i++) {
                        const stationA = stations[i];
                        const stationB = stations[i + 1];
                        
                        // ‰ΩøÁî®ÂîØ‰∏ÄÊ†áËØÜÁ¨¶‰Ωú‰∏∫ËäÇÁÇπÂêçÁß∞
                        const nodeA = `${stationA.name}_${stationA.line}`;
                        const nodeB = `${stationB.name}_${stationB.line}`;
                        
                        const distance = utils.calculateDistance(
                            stationA.X, stationA.Y,
                            stationB.X, stationB.Y
                        );
                        
                        if (!graph[nodeA]) graph[nodeA] = {};
                        if (!graph[nodeB]) graph[nodeB] = {};
                        
                        graph[nodeA][nodeB] = distance;
                        graph[nodeB][nodeA] = distance;
                    }
                });
                
                // ËøûÊé•Êç¢‰πòÁ´ôÔºàÂÖÅËÆ∏Ê≠•Ë°åË∑ØÁ∫øË∑Ø‰∏éÂú∞ÈìÅÁ∫øË∑Ø‰πãÈó¥ÁöÑÊç¢‰πòÔºâ
                allStations.forEach(stationA => {
                    // ÂØπ‰∫éÊ≠•Ë°åË∑ØÁ∫øË∑ØÔºåÂÖÅËÆ∏‰∏éÂú∞ÈìÅÁ∫øË∑ØÊç¢‰πòÔºåÂç≥‰ΩøÁ´ôÁÇπÊú¨Ë∫´‰∏çÊîØÊåÅÊç¢‰πò
                    const lineAInfo = lines.find(l => l.id === stationA.line);
                    const isWalkingLineA = lineAInfo && lineAInfo.lineType === 'walking';
                    
                    // Â¶ÇÊûúÁ´ôÁÇπÊîØÊåÅÊç¢‰πòÔºåÊàñËÄÖÊòØÊ≠•Ë°åË∑ØÁ∫øË∑ØÁöÑÁ´ôÁÇπÔºåÂàôÂÖÅËÆ∏Êç¢‰πòËøûÊé•
                    if (stationA.transfer || isWalkingLineA) {
                        const nodeA = `${stationA.name}_${stationA.line}`;
                        
                        // Êü•ÊâæÂêå‰∏Ä‰ΩçÁΩÆÁöÑÂÖ∂‰ªñÁ´ôÁÇπ
                        allStations.forEach(stationB => {
                            if (stationB.name === stationA.name && stationB.line !== stationA.line) {
                                // Êü•ÊâæÁ∫øË∑ØB‰ø°ÊÅØ
                                const lineBInfo = lines.find(l => l.id === stationB.line);
                                const isWalkingLineB = lineBInfo && lineBInfo.lineType === 'walking';
                                
                                // ÂØπ‰∫éÊ≠•Ë°åË∑ØÁ∫øË∑Ø‰∏éÂú∞ÈìÅÁ∫øË∑Ø‰πãÈó¥ÁöÑÊç¢‰πòÔºåÂÖÅËÆ∏ËøûÊé•
                                // ÊàñËÄÖ‰∏§‰∏™Á´ôÁÇπÈÉΩÊîØÊåÅÊç¢‰πò
                                if ((stationB.transfer || isWalkingLineB) && lineAInfo && lineBInfo && 
                                    !(lineAInfo.isExpress && lineBInfo.isExpress)) {
                                    
                                    const nodeB = `${stationB.name}_${stationB.line}`;
                                    
                                    if (!graph[nodeA]) graph[nodeA] = {};
                                    if (!graph[nodeB]) graph[nodeB] = {};
                                    
                                    // Êç¢‰πòË∑ùÁ¶ªËÆæ‰∏∫0ÔºàÂêå‰∏Ä‰ΩçÁΩÆÔºâ
                                    graph[nodeA][nodeB] = 0;
                                    graph[nodeB][nodeA] = 0;
                                }
                            }
                        });
                    }
                });
                
                return graph;
            },

            dijkstra(graph, start, end) {
                const distances = {};
                const previous = {};
                const nodes = new Set();
                
                // Â§ÑÁêÜËµ∑ÁÇπÂíåÁªàÁÇπÔºåÂ¶ÇÊûúÂÆÉ‰ª¨‰∏çÂåÖÂê´Á∫øË∑Ø‰ø°ÊÅØÔºåÈúÄË¶ÅÊâæÂà∞ÂØπÂ∫îÁöÑËäÇÁÇπ
                let startNode = start;
                let endNode = end;
                
                if (!start.includes('_')) {
                    const matchingNodes = Object.keys(graph).filter(node => node.startsWith(start + '_'));
                    if (matchingNodes.length > 0) {
                        startNode = matchingNodes[0];
                    }
                }
                
                if (!end.includes('_')) {
                    const matchingNodes = Object.keys(graph).filter(node => node.startsWith(end + '_'));
                    if (matchingNodes.length > 0) {
                        endNode = matchingNodes[0];
                    }
                }
                
                // ÂàùÂßãÂåñ
                for (let node in graph) {
                    distances[node] = Infinity;
                    previous[node] = null;
                    nodes.add(node);
                }
                distances[startNode] = 0;
                
                while (nodes.size > 0) {
                    let smallest = null;
                    for (let node of nodes) {
                        if (smallest === null || distances[node] < distances[smallest]) {
                            smallest = node;
                        }
                    }
                    
                    if (smallest === endNode) break;
                    
                    nodes.delete(smallest);
                    
                    for (let neighbor in graph[smallest]) {
                        const edgeWeight = graph[smallest][neighbor];
                        const alt = distances[smallest] + edgeWeight;
                        if (alt < distances[neighbor]) {
                            distances[neighbor] = alt;
                            previous[neighbor] = smallest;
                        }
                    }
                }
                
                // ÊûÑÂª∫Ë∑ØÂæÑ
                const path = [];
                let current = endNode;
                while (current !== null) {
                    path.unshift(current);
                    current = previous[current];
                }
                
                return {
                    distance: distances[endNode],
                    path: path
                };
            },

            analyzeTransfers(route, lines) {
                const transfers = [];
                let currentLine = null;
                let currentSegment = [];
                
                route.path.forEach((station, index) => {
                    // Êü•ÊâæÁ´ôÁÇπ‰ø°ÊÅØÔºåËÄÉËôëÁ´ôÁÇπÂêçÁß∞ÂèØËÉΩÈáçÂ§çÁöÑÊÉÖÂÜµ
                    const stationInfo = appState.stations.find(s => {
                        // Â¶ÇÊûúË∑ØÂæÑ‰∏≠ÁöÑÁ´ôÁÇπÂêçÁß∞ÂåÖÂê´Á∫øË∑Ø‰ø°ÊÅØÔºàÂ¶Ç"Âª∫ÂõΩÈó®Á´ô_1"ÔºâÔºåÂàôÁ≤æÁ°ÆÂåπÈÖç
                        if (station.includes('_')) {
                            return s.name === station.split('_')[0] && s.line === station.split('_')[1];
                        }
                        // Âê¶ÂàôÊåâÂêçÁß∞ÂåπÈÖç
                        return s.name === station;
                    });
                    
                    if (!stationInfo) return;
                    
                    // Êü•ÊâæÁ∫øË∑Ø‰ø°ÊÅØ
                    const lineInfo = lines.find(l => l.id === stationInfo.line);
                    
                    // Â¶ÇÊûúÊòØÊ≠•Ë°åË∑ØÁ∫øË∑ØÔºåÊòæÁ§∫‰∏∫Ê≠•Ë°åÊç¢‰πò
                    if (lineInfo && lineInfo.lineType === 'walking') {
                        if (currentSegment.length > 1) { // Âè™Ê∑ªÂä†Ëá≥Â∞ëÂåÖÂê´2‰∏™Á´ôÁÇπÁöÑÁ∫øË∑ØÊÆµ
                            transfers.push({
                                line: currentLine,
                                lineName: lines.find(l => l.id === currentLine)?.name || `Á∫øË∑Ø${currentLine}`,
                                stations: [...currentSegment]
                            });
                        }
                        // Ê∑ªÂä†Ê≠•Ë°åË∑ØÁ∫øË∑ØÊç¢‰πò
                        transfers.push({
                            line: stationInfo.line,
                            lineName: "Ê≠•Ë°åË∑Ø",
                            stations: [station]
                        });
                        currentLine = null;
                        currentSegment = [];
                        return;
                    }
                    
                    if (stationInfo.line !== currentLine) {
                        if (currentSegment.length > 1) { // Âè™Ê∑ªÂä†Ëá≥Â∞ëÂåÖÂê´2‰∏™Á´ôÁÇπÁöÑÁ∫øË∑ØÊÆµ
                            transfers.push({
                                line: currentLine,
                                lineName: lines.find(l => l.id === currentLine)?.name || `Á∫øË∑Ø${currentLine}`,
                                stations: [...currentSegment]
                            });
                        }
                        currentLine = stationInfo.line;
                        currentSegment = [station];
                    } else {
                        currentSegment.push(station);
                    }
                });
                
                if (currentSegment.length > 1) { // Âè™Ê∑ªÂä†Ëá≥Â∞ëÂåÖÂê´2‰∏™Á´ôÁÇπÁöÑÁ∫øË∑ØÊÆµ
                    transfers.push({
                        line: currentLine,
                        lineName: lines.find(l => l.id === currentLine)?.name || `Á∫øË∑Ø${currentLine}`,
                        stations: currentSegment
                    });
                }
                
                return transfers;
            }
        };

        // Âú∞ÂõæÊ∏≤ÊüìÂáΩÊï∞
        const mapRenderer = {
            init() {
                appState.canvas = document.getElementById('mapCanvas');
                appState.ctx = appState.canvas.getContext('2d');
                
                this.resizeCanvas();
                window.addEventListener('resize', () => this.resizeCanvas());
                
                // ÁªëÂÆö‰∫ã‰ª∂Ôºà‰ΩøÁî®ÁÆ≠Â§¥ÂáΩÊï∞‰øùÊåÅÊ≠£Á°ÆÁöÑthis‰∏ä‰∏ãÊñáÔºâ
                appState.canvas.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                appState.canvas.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                appState.canvas.addEventListener('mouseup', () => this.handleMouseUp());
                appState.canvas.addEventListener('wheel', (e) => this.handleWheel(e));
                
                // Ëß¶Êë∏‰∫ã‰ª∂ÊîØÊåÅ
                appState.canvas.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                appState.canvas.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                appState.canvas.addEventListener('touchend', () => this.handleTouchEnd());
            },

            resizeCanvas() {
                appState.canvas.width = appState.canvas.clientWidth;
                appState.canvas.height = appState.canvas.clientHeight;
                this.render();
            },

            handleMouseDown(e) {
                appState.isDragging = true;
                appState.lastMousePos = { x: e.clientX, y: e.clientY };
                appState.canvas.style.cursor = 'grabbing';
            },

            handleMouseMove(e) {
                if (appState.isDragging) {
                    const deltaX = e.clientX - appState.lastMousePos.x;
                    const deltaY = e.clientY - appState.lastMousePos.y;
                    
                    // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãË∞ÉÊï¥ÁßªÂä®ÈÄüÂ∫¶Ôºà‰ΩøÁî®Âπ≥ÊñπÊ†πÂáΩÊï∞ÂÆûÁé∞Êõ¥Âπ≥ÊªëÁöÑË∞ÉÊï¥Ôºâ
                    const speedFactor = Math.sqrt(1 / appState.mapScale);
                    appState.mapOffset.x += deltaX * speedFactor;
                    appState.mapOffset.y += deltaY * speedFactor;
                    
                    appState.lastMousePos = { x: e.clientX, y: e.clientY };
                    this.render();
                }
            },

            handleMouseUp() {
                appState.isDragging = false;
                appState.canvas.style.cursor = 'grab';
            },

            handleWheel(e) {
                e.preventDefault();
                
                // Ëé∑ÂèñÈº†Ê†áÁõ∏ÂØπ‰∫éÁîªÂ∏ÉÁöÑ‰ΩçÁΩÆ
                const canvasRect = appState.canvas.getBoundingClientRect();
                const mouseX = e.clientX - canvasRect.left;
                const mouseY = e.clientY - canvasRect.top;
                
                // ËÆ°ÁÆóÁº©ÊîæÂâçÁöÑÈº†Ê†á‰ΩçÁΩÆÂØπÂ∫îÁöÑ‰∏ñÁïåÂùêÊ†á
                const oldScale = appState.mapScale;
                const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
                const newScale = Math.max(0.5, Math.min(3, oldScale * zoomFactor));
                
                // ËÆ°ÁÆóÁº©Êîæ‰∏≠ÂøÉÁöÑ‰∏ñÁïåÂùêÊ†á
                const centerX = appState.canvas.width / 2;
                const centerY = appState.canvas.height / 2;
                const scale = 2; // ‰∏éworldToScreen‰∏≠ÁöÑscale‰∏ÄËá¥
                const offsetX = 400; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetX‰∏ÄËá¥
                const offsetY = -100; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetY‰∏ÄËá¥
                
                // Â∞ÜÈº†Ê†á‰ΩçÁΩÆËΩ¨Êç¢‰∏∫‰∏ñÁïåÂùêÊ†á
                const worldX = (mouseX - centerX - appState.mapOffset.x) / (scale * oldScale) - offsetX;
                const worldY = (mouseY - centerY - appState.mapOffset.y) / (scale * oldScale) - offsetY;
                
                // Êõ¥Êñ∞Áº©ÊîæÊØî‰æã
                appState.mapScale = newScale;
                
                // ËÆ°ÁÆóÁº©ÊîæÂêéÁöÑÈº†Ê†á‰ΩçÁΩÆÂ∫îËØ•ÂØπÂ∫îÁöÑÂ±èÂπïÂùêÊ†á
                const newScreenX = centerX + (worldX + offsetX) * scale * newScale + appState.mapOffset.x;
                const newScreenY = centerY + (worldY + offsetY) * scale * newScale + appState.mapOffset.y;
                
                // Ë∞ÉÊï¥Âú∞ÂõæÂÅèÁßªÈáèÔºå‰ΩøÈº†Ê†á‰ΩçÁΩÆ‰øùÊåÅ‰∏çÂèò
                appState.mapOffset.x += mouseX - newScreenX;
                appState.mapOffset.y += mouseY - newScreenY;
                
                this.render();
            },

            handleTouchStart(e) {
                e.preventDefault();
                if (e.touches.length === 1) {
                    appState.isDragging = true;
                    appState.lastTouchPos = { 
                        x: e.touches[0].clientX, 
                        y: e.touches[0].clientY 
                    };
                } else if (e.touches.length === 2) {
                    appState.isPinching = true;
                    appState.lastTouchDistance = this.getTouchDistance(e.touches[0], e.touches[1]);
                    // ‰øùÂ≠òÂ§öÊåáËêΩÁÇπ‰∏≠ÂøÉ‰ΩçÁΩÆ
                    appState.lastTouchCenter = this.getTouchCenter(e.touches[0], e.touches[1]);
                }
            },

            handleTouchMove(e) {
                e.preventDefault();
                if (appState.isDragging && e.touches.length === 1) {
                    const deltaX = e.touches[0].clientX - appState.lastTouchPos.x;
                    const deltaY = e.touches[0].clientY - appState.lastTouchPos.y;
                    
                    // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãË∞ÉÊï¥ÁßªÂä®ÈÄüÂ∫¶Ôºà‰ΩøÁî®Âπ≥ÊñπÊ†πÂáΩÊï∞ÂÆûÁé∞Êõ¥Âπ≥ÊªëÁöÑË∞ÉÊï¥Ôºâ
                    const speedFactor = Math.sqrt(1 / appState.mapScale);
                    appState.mapOffset.x += deltaX * speedFactor;
                    appState.mapOffset.y += deltaY * speedFactor;
                    
                    appState.lastTouchPos = { 
                        x: e.touches[0].clientX, 
                        y: e.touches[0].clientY 
                    };
                    this.render();
                } else if (appState.isPinching && e.touches.length === 2) {
                    const currentDistance = this.getTouchDistance(e.touches[0], e.touches[1]);
                    const scaleFactor = currentDistance / appState.lastTouchDistance;
                    
                    // Ëé∑ÂèñÂΩìÂâçÂ§öÊåáËêΩÁÇπ‰∏≠ÂøÉ
                    const currentCenter = this.getTouchCenter(e.touches[0], e.touches[1]);
                    
                    // ‰øùÂ≠òÊóßÁöÑÁº©ÊîæÊØî‰æã
                    const oldScale = appState.mapScale;
                    
                    // Êõ¥Êñ∞Áº©ÊîæÊØî‰æã
                    appState.mapScale = Math.max(0.5, Math.min(3, appState.mapScale * scaleFactor));
                    appState.lastTouchDistance = currentDistance;
                    
                    // ‰ª•Â§öÊåáËêΩÁÇπ‰∏≠ÂøÉ‰∏∫Áº©Êîæ‰∏≠ÂøÉÔºåË∞ÉÊï¥Âú∞ÂõæÂÅèÁßªÈáè
                    this.adjustOffsetForPinchZoom(oldScale, appState.lastTouchCenter, currentCenter);
                    
                    // Êõ¥Êñ∞‰∏≠ÂøÉ‰ΩçÁΩÆ
                    appState.lastTouchCenter = currentCenter;
                    
                    this.render();
                }
            },

            handleTouchEnd() {
                appState.isDragging = false;
                appState.isPinching = false;
            },

            getTouchDistance(touch1, touch2) {
                const dx = touch1.clientX - touch2.clientX;
                const dy = touch1.clientY - touch2.clientY;
                return Math.sqrt(dx * dx + dy * dy);
            },

            getTouchCenter(touch1, touch2) {
                return {
                    x: (touch1.clientX + touch2.clientX) / 2,
                    y: (touch1.clientY + touch2.clientY) / 2
                };
            },

            adjustOffsetForPinchZoom(oldScale, oldCenter, newCenter) {
                const canvasRect = appState.canvas.getBoundingClientRect();
                
                // Â∞ÜÂ±èÂπïÂùêÊ†áËΩ¨Êç¢‰∏∫Áõ∏ÂØπ‰∫éÁîªÂ∏ÉÁöÑÂùêÊ†á
                const oldCenterX = oldCenter.x - canvasRect.left;
                const oldCenterY = oldCenter.y - canvasRect.top;
                const newCenterX = newCenter.x - canvasRect.left;
                const newCenterY = newCenter.y - canvasRect.top;
                
                // ËÆ°ÁÆóÁº©ÊîæÂâçÁöÑ‰∏≠ÂøÉÁÇπÂØπÂ∫îÁöÑ‰∏ñÁïåÂùêÊ†á
                const centerX = appState.canvas.width / 2;
                const centerY = appState.canvas.height / 2;
                const scale = 2; // ‰∏éworldToScreen‰∏≠ÁöÑscale‰∏ÄËá¥
                const offsetX = 400; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetX‰∏ÄËá¥
                const offsetY = -100; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetY‰∏ÄËá¥
                
                // Â∞ÜÊóßÁöÑ‰∏≠ÂøÉÁÇπ‰ΩçÁΩÆËΩ¨Êç¢‰∏∫‰∏ñÁïåÂùêÊ†á
                const worldX = (oldCenterX - centerX - appState.mapOffset.x) / (scale * oldScale) - offsetX;
                const worldY = (oldCenterY - centerY - appState.mapOffset.y) / (scale * oldScale) - offsetY;
                
                // ËÆ°ÁÆóÁº©ÊîæÂêéÁöÑ‰∏≠ÂøÉÁÇπÂ∫îËØ•ÂØπÂ∫îÁöÑÂ±èÂπïÂùêÊ†á
                const newScreenX = centerX + (worldX + offsetX) * scale * appState.mapScale + appState.mapOffset.x;
                const newScreenY = centerY + (worldY + offsetY) * scale * appState.mapScale + appState.mapOffset.y;
                
                // Ë∞ÉÊï¥Âú∞ÂõæÂÅèÁßªÈáèÔºå‰ΩøÊñ∞ÁöÑ‰∏≠ÂøÉÁÇπ‰ΩçÁΩÆ‰øùÊåÅ‰∏çÂèò
                appState.mapOffset.x += newCenterX - newScreenX;
                appState.mapOffset.y += newCenterY - newScreenY;
            },

            worldToScreen(x, y) {
                const centerX = appState.canvas.width / 2;
                const centerY = appState.canvas.height / 2;
                
                // Ê†πÊçÆÊï∞ÊçÆËåÉÂõ¥‰ºòÂåñÂπ≥Èù¢ÂùêÊ†áÁ≥ªËΩ¨Êç¢
                // Êï∞ÊçÆËåÉÂõ¥Ôºöx: -963 Âà∞ 39.9, y: 18 Âà∞ 333
                // ‰ΩøÁî®Êõ¥ÂêàÈÄÇÁöÑÁº©ÊîæÂõ†Â≠êÂíåÂÅèÁßªÈáè
                const scale = 2; // ‰ºòÂåñÂêéÁöÑÁº©ÊîæÂõ†Â≠ê
                const offsetX = 400; // xËΩ¥ÂÅèÁßªÔºå‰ΩøÊï∞ÊçÆÂ±Ö‰∏≠ÊòæÁ§∫
                const offsetY = -100; // yËΩ¥ÂÅèÁßªÔºå‰ΩøÊï∞ÊçÆÂ±Ö‰∏≠ÊòæÁ§∫
                
                const screenX = centerX + (x + offsetX) * scale * appState.mapScale + appState.mapOffset.x;
                const screenY = centerY + (y + offsetY) * scale * appState.mapScale + appState.mapOffset.y;
                
                return { x: screenX, y: screenY };
            },

            clearMap() {
                appState.ctx.clearRect(0, 0, appState.canvas.width, appState.canvas.height);
                this.clearStationLabels();
                this.clearLineLabels();
            },

            clearStationLabels() {
                appState.stationLabels.forEach(label => label.remove());
                appState.stationLabels = [];
            },

            clearLineLabels() {
                if (appState.lineLabels) {
                    appState.lineLabels.forEach(label => label.remove());
                    appState.lineLabels = [];
                }
            },

            displayStations(lines) {
                this.clearStationLabels();
                
                lines.forEach(line => {
                    line.stations.forEach(station => {
                        // Ë∑≥ËøáËäÇÁÇπÔºå‰∏çÊòæÁ§∫ËäÇÁÇπÊ†áËÆ∞
                        if (station.type === 'node') {
                            return;
                        }
                        
                        const screenPos = this.worldToScreen(station.X, station.Y);
                        
                        // ÁªòÂà∂Á´ôÁÇπÊ†áËÆ∞ - ÈÄöËøá‰∏§‰∏™ÈáçÂè†ÁöÑÂúÜÂÆûÁé∞ÈªëËâ≤ÊèèËæπÁôΩËâ≤ËÉåÊôØ
                        
                        // ÂÖàÁªòÂà∂Â§ßÈªëÂúÜ‰Ωú‰∏∫ÊèèËæπ
                        appState.ctx.beginPath();
                        const outerRadius = 6 * appState.mapScale;
                        appState.ctx.arc(screenPos.x, screenPos.y, outerRadius, 0, 2 * Math.PI);
                        appState.ctx.fillStyle = '#000000';
                        appState.ctx.fill();
                        
                        // ÂÜçÁªòÂà∂ÂÜÖÂúÜ‰Ωú‰∏∫ËÉåÊôØ
                        appState.ctx.beginPath();
                        const innerRadius = 5.5 * appState.mapScale;
                        appState.ctx.arc(screenPos.x, screenPos.y, innerRadius, 0, 2 * Math.PI);
                        appState.ctx.fillStyle = '#FFFFFF';
                        appState.ctx.fill();
                        
                        // Ê∑ªÂä†Á´ôÂêçÊ†áÁ≠æ
                        this.addStationLabel(station, screenPos.x, screenPos.y);
                    });
                });
            },

            addStationLabel(station, x, y) {
                // Ë∑≥ËøáËäÇÁÇπÔºå‰∏çÊòæÁ§∫ËäÇÁÇπÊ†áÁ≠æ
                if (station.type === 'node') {
                    return;
                }
                
                const label = document.createElement('div');
                label.className = 'station-label';
                
                // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãÂä®ÊÄÅËÆ°ÁÆóÂ≠ó‰ΩìÂ§ßÂ∞è
                const baseFontScale = appState.mapScale;
                const chineseFontSize = Math.max(8, 11 * baseFontScale); // ‰∏≠ÊñáÁ´ôÂêçÂü∫Á°ÄÂ§ßÂ∞è11px
                const englishFontSize = Math.max(6, 9 * baseFontScale);  // Ëã±ÊñáÁ´ôÂêçÂü∫Á°ÄÂ§ßÂ∞è9px
                const transferFontSize = Math.max(6, 8 * baseFontScale); // Êç¢‰πò‰ø°ÊÅØÂü∫Á°ÄÂ§ßÂ∞è8px
                const platformFontSize = Math.max(5, 7 * baseFontScale); // Á´ôÂè∞‰ø°ÊÅØÂü∫Á°ÄÂ§ßÂ∞è7px
                
                // ÂàõÂª∫ÂèåËØ≠ÊòæÁ§∫Ôºö‰∏≠ÊñáÂêçÁß∞ + Ëã±ÊñáÂêçÁß∞
                const chineseName = station.name;
                const englishName = station.englishName;
                
                // ÂàõÂª∫ËøêËê•Âçï‰Ωç‰ø°ÊÅØÊòæÁ§∫
                let managementInfo = '';
                if (station.management) {
                    managementInfo = `<div class="station-management" style="font-size: ${transferFontSize}px; color: #a00;">${station.management}</div>`;
                }
                
                // ÂàõÂª∫Êç¢‰πò‰ø°ÊÅØÊòæÁ§∫ - Â§ÑÁêÜÁ∫øË∑ØÊï∞ÂíåÁ´ôÂè∞Êï∞‰∏çÁ≠âÁöÑÊÉÖÂÜµ
                let transferInfo = '';
                if (station.transfer && station.transferLines.length > 0) {
                    const transferLines = station.transferLines.join('„ÄÅ');
                    
                    // Âè™ÊúâÂΩìÊúâÊç¢‰πòÁ´ôÂè∞‰ø°ÊÅØÊó∂ÊâçÊòæÁ§∫Á´ôÂè∞‰ø°ÊÅØ
                    let platformsInfo = '';
                    if (station.transferPlatforms && station.transferPlatforms.length > 0) {
                        const transferPlatforms = station.transferPlatforms.join('„ÄÅ');
                        platformsInfo = `<div class="transfer-platforms" style="font-size: ${platformFontSize}px;">Êç¢‰πòÁ´ôÂè∞Ôºö${transferPlatforms}</div>`;
                    }
                    
                    transferInfo = `
                        <div class="station-transfer-info" style="font-size: ${transferFontSize}px;">
                            <div class="transfer-lines">Êç¢‰πòÁ∫øË∑ØÔºö${transferLines}</div>
                            ${platformsInfo}
                        </div>
                    `;
                }
                
                label.innerHTML = `
                    <div class="station-name-chinese" style="font-size: ${chineseFontSize}px;">${chineseName}</div>
                    <div class="station-name-english" style="font-size: ${englishFontSize}px;">${englishName}</div>
                    ${managementInfo}
                    ${transferInfo}
                `;
                
                // Á´ôÂêçÊ†áÁ≠æÂõ∫ÂÆöÂú®Á´ôÁÇπ‰∏äÊñπ
                const labelOffset = 20 * baseFontScale;
                let left = x;
                let top = y - labelOffset; // Âõ∫ÂÆöÂú®Á´ôÁÇπ‰∏äÊñπ
                
                // ‰ΩøÁî®CSS transformÂÆûÁé∞Á≤æÁ°ÆÂ±Ö‰∏≠
                // CSS‰∏≠Â∑≤Êúâ transform: translate(-50%, -100%); ÂÆûÁé∞Ê∞¥Âπ≥Â±Ö‰∏≠ÂíåÂûÇÁõ¥ÂØπÈΩê
                
                label.style.left = left + 'px';
                label.style.top = top + 'px';
                
                document.querySelector('.map-container').appendChild(label);
                appState.stationLabels.push(label);
            },
            
            // Ê∑ªÂä†Á∫øË∑ØIDÊ†áÁ≠æÔºàÂ∏¶Á∫øË∑ØÈ¢úËâ≤ËÉåÊôØÔºâ
            addLineLabel(line, x, y) {
                const label = document.createElement('div');
                label.className = 'line-label';
                
                // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãÂä®ÊÄÅËÆ°ÁÆóÂ≠ó‰ΩìÂ§ßÂ∞è
                const baseFontScale = appState.mapScale;
                const fontSize = Math.max(10, 14 * baseFontScale);
                
                // ËÆæÁΩÆÊ†áÁ≠æÊ†∑Âºè
                label.style.fontSize = fontSize + 'px';
                label.style.fontWeight = 'bold';
                label.style.color = '#FFFFFF'; // ÁôΩËâ≤ÊñáÂ≠ó
                label.style.backgroundColor = line.color; // Á∫øË∑ØÈ¢úËâ≤ËÉåÊôØ
                label.style.padding = '2px 6px';
                label.style.borderRadius = '4px';
                label.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.3)';
                label.style.whiteSpace = 'nowrap';
                label.style.zIndex = '90'; // ‰Ωé‰∫éÁ´ôÁÇπÊ†áÁ≠æ‰ΩÜÈ´ò‰∫éÁ∫øË∑Ø
                label.style.pointerEvents = 'none';
                label.style.position = 'absolute';
                label.style.textAlign = 'center';
                
                // ËÆæÁΩÆÊ†áÁ≠æÂÜÖÂÆπÔºàÊ≠•Ë°åË∑ØÁ∫øË∑ØÂè™ÊòæÁ§∫ÂêçÁß∞Ôºå‰∏çÊòæÁ§∫IDÔºâ
                label.textContent = line.name;
                
                // ËÆæÁΩÆÊ†áÁ≠æ‰ΩçÁΩÆÔºöÊõ¥Èù†ËøëÁ∫øË∑Ø‰∏≠ÂøÉÔºåÁ°Æ‰øùÁî®Êà∑ËÉΩÁúãÂà∞
                // ‰ΩøÁî®Êõ¥Â∞èÁöÑÂÅèÁßªÈáèÔºåËÆ©Ê†áÁ≠æÊõ¥Ë¥¥ËøëÁ∫øË∑Ø
                const offset = 6 * baseFontScale; // ‰ΩøÁî®ËæÉÂ∞èÁöÑÂÅèÁßªÈáè
                
                // ËÆ°ÁÆóÊ†áÁ≠æÁöÑËæπÁïå‰ΩçÁΩÆ
                let finalX = x + offset;
                let finalY = y - offset;
                
                // ÁÆÄÂçïÁöÑËæπÁïåÊ£ÄÊü•ÔºåÁ°Æ‰øùÊ†áÁ≠æÂú®ÂèØËßÜÂå∫ÂüüÂÜÖ
                const mapContainer = document.querySelector('.map-container');
                const containerRect = mapContainer.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const containerHeight = containerRect.height;
                
                // ËÆ°ÁÆóÊ†áÁ≠æÁöÑÈ¢Ñ‰º∞Â∞∫ÂØ∏
                const labelWidth = label.textContent.length * fontSize * 0.6 + 12;
                const labelHeight = fontSize + 4;
                
                // Á°Æ‰øùÊ†áÁ≠æ‰∏çË∂ÖÂá∫ËæπÁïå
                if (finalX - labelWidth/2 < 0) {
                    finalX = labelWidth/2 + 10;
                }
                if (finalX + labelWidth/2 > containerWidth) {
                    finalX = containerWidth - labelWidth/2 - 10;
                }
                if (finalY - labelHeight/2 < 0) {
                    finalY = labelHeight/2 + 10;
                }
                if (finalY + labelHeight/2 > containerHeight) {
                    finalY = containerHeight - labelHeight/2 - 10;
                }
                
                label.style.left = finalX + 'px';
                label.style.top = finalY + 'px';
                
                // ‰ΩøÁî®CSS transformÂÆûÁé∞Á≤æÁ°ÆÂ±Ö‰∏≠
                label.style.transform = 'translate(-50%, -50%)';
                
                // Â¢ûÂº∫Èò¥ÂΩ±ÊïàÊûúÔºåÊèêÈ´òÂèØËØªÊÄß
                label.style.textShadow = '0 2px 4px rgba(0, 0, 0, 0.7)';
                
                // Ê∑ªÂä†ËæπÊ°ÜÂ¢ûÂº∫ÂØπÊØîÂ∫¶
                label.style.border = '1px solid rgba(255, 255, 255, 0.3)';
                
                document.querySelector('.map-container').appendChild(label);
                appState.lineLabels = appState.lineLabels || [];
                appState.lineLabels.push(label);
            },
            
            // Ëé∑ÂèñÁ´ôÁÇπÁöÑËã±ÊñáÂêçÁß∞
            getEnglishName(chineseName) {
                // ‰ªéËß£ÊûêÁöÑÊï∞ÊçÆ‰∏≠Êü•ÊâæÂØπÂ∫îÁöÑËã±ÊñáÂêçÁß∞
                const station = appState.stations.find(s => s.name === chineseName);
                return station ? station.englishName : chineseName;
            },

            // Ê£ÄÊµãÁ∫øË∑Ø‰∏äÁöÑËΩ¨ÊäòÁÇπ
            findTurnPoints(line) {
                const turnPoints = [];
                
                if (line.stations.length < 3) {
                    return turnPoints; // Â∞ë‰∫é3‰∏™Á´ôÁÇπÊó†Ê≥ïÂΩ¢ÊàêËΩ¨Êäò
                }
                
                // Ê£ÄÊü•ÊØè‰∏™‰∏≠Èó¥Á´ôÁÇπÊòØÂê¶‰∏∫ËΩ¨ÊäòÁÇπ
                for (let i = 1; i < line.stations.length - 1; i++) {
                    const prevStation = line.stations[i - 1];
                    const currentStation = line.stations[i];
                    const nextStation = line.stations[i + 1];
                    
                    // ËÆ°ÁÆóÂêëÈáè
                    const vec1 = {
                        x: currentStation.X - prevStation.X,
                        y: currentStation.Y - prevStation.Y
                    };
                    const vec2 = {
                        x: nextStation.X - currentStation.X,
                        y: nextStation.Y - currentStation.Y
                    };
                    
                    // ËÆ°ÁÆóÂêëÈáèÂ§πËßíÔºà‰ΩøÁî®ÁÇπÁßØÂÖ¨ÂºèÔºâ
                    const dotProduct = vec1.x * vec2.x + vec1.y * vec2.y;
                    const magnitude1 = Math.sqrt(vec1.x * vec1.x + vec1.y * vec1.y);
                    const magnitude2 = Math.sqrt(vec2.x * vec2.x + vec2.y * vec2.y);
                    
                    if (magnitude1 > 0 && magnitude2 > 0) {
                        const cosAngle = dotProduct / (magnitude1 * magnitude2);
                        const angle = Math.acos(Math.max(-1, Math.min(1, cosAngle))) * (180 / Math.PI);
                        
                        // Â¶ÇÊûúÂ§πËßíÂ∞è‰∫é150Â∫¶ÔºåËÆ§‰∏∫ÊòØËΩ¨ÊäòÁÇπ
                        if (angle < 150) {
                            turnPoints.push({
                                station: currentStation,
                                angle: angle,
                                index: i
                            });
                        }
                    }
                }
                
                return turnPoints;
            },

            // ÁªòÂà∂Â∏¶ËΩ¨ÊäòÁÇπÁöÑÁ∫øË∑ØÔºàÊîØÊåÅÊîØÁ∫øÔºâ
            displayLinesWithTurns(lines) {
                lines.forEach(line => {
                    // Ê£ÄÊü•ÊòØÂê¶ÊòØÊîØÁ∫ø
                    const isBranchLine = line.branchOf && line.branchName;
                    
                    if (line.stations.length > 1) {
                        // Êü•ÊâæËΩ¨ÊäòÁÇπ
                        const turnPoints = this.findTurnPoints(line);
                        
                        // Â¶ÇÊûúÊ≤°ÊúâËΩ¨ÊäòÁÇπÔºåÁõ¥Êé•ÁªòÂà∂Áõ¥Á∫ø
                        if (turnPoints.length === 0) {
                            this.drawStraightLine(line, isBranchLine);
                        } else {
                            // ÂàÜÊÆµÁªòÂà∂Á∫øË∑ØÔºåÂú®ËΩ¨ÊäòÁÇπÂ§ÑÊñ≠ÂºÄ
                            this.drawSegmentedLine(line, turnPoints, isBranchLine);
                        }
                    }
                    
                    // Â¶ÇÊûúËøôÊù°Á∫øË∑ØÊúâÊîØÁ∫øÔºå‰πüÁªòÂà∂ÊîØÁ∫ø
                    if (line.branches && Object.keys(line.branches).length > 0) {
                        Object.values(line.branches).forEach(branchLine => {
                            if (branchLine.stations.length > 1) {
                                const branchTurnPoints = this.findTurnPoints(branchLine);
                                
                                if (branchTurnPoints.length === 0) {
                                    this.drawStraightLine(branchLine, true);
                                } else {
                                    this.drawSegmentedLine(branchLine, branchTurnPoints, true);
                                }
                            }
                        });
                    }
                });
            },

            // ÁªòÂà∂Áõ¥Á∫øÁ∫øË∑ØÔºàÊó†ËΩ¨ÊäòÁÇπÔºâ
            drawStraightLine(line, isBranchLine = false) {
                appState.ctx.beginPath();
                
                line.stations.forEach((station, index) => {
                    const screenPos = this.worldToScreen(station.X, station.Y);
                    
                    if (index === 0) {
                        appState.ctx.moveTo(screenPos.x, screenPos.y);
                    } else {
                        appState.ctx.lineTo(screenPos.x, screenPos.y);
                    }
                });
                
                this.applyLineStyle(line, isBranchLine);
            },

            // ÁªòÂà∂ÂàÜÊÆµÁ∫øË∑ØÔºàÊúâËΩ¨ÊäòÁÇπÔºâ
            drawSegmentedLine(line, turnPoints, isBranchLine = false) {
                const segments = [];
                let startIndex = 0;
                
                // Ê†πÊçÆËΩ¨ÊäòÁÇπÂàÜÂâ≤Á∫øË∑Ø
                turnPoints.forEach(turnPoint => {
                    segments.push({
                        start: startIndex,
                        end: turnPoint.index,
                        stations: line.stations.slice(startIndex, turnPoint.index + 1)
                    });
                    startIndex = turnPoint.index;
                });
                
                // Ê∑ªÂä†ÊúÄÂêé‰∏ÄÊÆµ
                segments.push({
                    start: startIndex,
                    end: line.stations.length - 1,
                    stations: line.stations.slice(startIndex)
                });
                
                // ÁªòÂà∂ÊØèÊÆµÁ∫øË∑Ø
                segments.forEach(segment => {
                    if (segment.stations.length > 1) {
                        appState.ctx.beginPath();
                        
                        segment.stations.forEach((station, index) => {
                            const screenPos = this.worldToScreen(station.X, station.Y);
                            
                            if (index === 0) {
                                appState.ctx.moveTo(screenPos.x, screenPos.y);
                            } else {
                                appState.ctx.lineTo(screenPos.x, screenPos.y);
                            }
                        });
                        
                        this.applyLineStyle(line, isBranchLine);
                    }
                });
            },

            // Â∫îÁî®Á∫øË∑ØÊ†∑ÂºèÔºàÊîØÊåÅÊîØÁ∫øÔºâ
            applyLineStyle(line, isBranchLine = false) {
                appState.ctx.strokeStyle = line.color;
                
                // ‰∏≠ÂõΩÈìÅË∑ØÁâπÂø´Á∫øÊ†∑ÂºèÔºöÊõ¥Á≤óÁöÑÁ∫øÊù°ÂíåËôöÁ∫øÊ†∑Âºè
                console.log(`Ê∏≤ÊüìÁ∫øË∑Ø ${line.name} - isExpress: ${line.isExpress}, lineType: ${line.lineType}, isBranchLine: ${isBranchLine}`);
                
                if (line.lineType === 'walking') {
                    // Ê≠•Ë°åË∑ØÊ†∑ÂºèÔºöÁâπÂø´Á∫øÊ†∑ÂºèÊîπÁÅ∞ÔºåÂéªÈô§ÊèèËæπÔºåÂ¢ûÂä†Á∫øÊÆµË∑ùÁ¶ªÔºåÊ∑ªÂä†ÂúÜËßí
                    console.log(`Â∫îÁî®Ê≠•Ë°åË∑ØÊ†∑ÂºèÂà∞Á∫øË∑Ø ${line.name}`);
                    
                    appState.ctx.lineCap = 'round'; // Ê∑ªÂä†ÂúÜËßíÊïàÊûú
                    
                    // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãÂä®ÊÄÅË∞ÉÊï¥ËôöÁ∫øÊ†∑ÂºèÔºåÂ¢ûÂä†Á∫øÊÆµË∑ùÁ¶ª
                    const dashLength = 12 * appState.mapScale;
                    const gapLength = 12 * appState.mapScale; // Â¢ûÂä†Èó¥ÈöôË∑ùÁ¶ª
                    
                    // Áõ¥Êé•ÁªòÂà∂ÁÅ∞Ëâ≤ËôöÁ∫øÔºåÂéªÈô§ÊèèËæπ
                    appState.ctx.setLineDash([dashLength, gapLength]); // ËôöÁ∫øÊ†∑Âºè
                    appState.ctx.strokeStyle = '#808080'; // ÁÅ∞Ëâ≤
                    appState.ctx.lineWidth = 6 * appState.mapScale; // ‰∏éÁâπÂø´Á∫øÂΩ©Ëâ≤Á∫øÊù°ÂÆΩÂ∫¶‰∏ÄËá¥
                    appState.ctx.stroke();
                    
                } else if (isBranchLine) {
                    // ÊîØÁ∫øÊ†∑ÂºèÔºöÊõ¥ÁªÜÁöÑËôöÁ∫øÔºå‰∏é‰∏ªÁ∫øË∑ØÂå∫ÂàÜ
                    console.log(`Â∫îÁî®ÊîØÁ∫øÊ†∑ÂºèÂà∞Á∫øË∑Ø ${line.name}`);
                    
                    appState.ctx.lineCap = 'round'; // ÂúÜËßíÊïàÊûú
                    
                    // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãÂä®ÊÄÅË∞ÉÊï¥ËôöÁ∫øÊ†∑Âºè
                    const dashLength = 8 * appState.mapScale;
                    const gapLength = 6 * appState.mapScale;
                    
                    // ÊîØÁ∫ø‰ΩøÁî®Êõ¥ÁªÜÁöÑËôöÁ∫øÔºåÊó†ÊèèËæπ
                    appState.ctx.setLineDash([dashLength, gapLength]); // ËôöÁ∫øÊ†∑Âºè
                    appState.ctx.strokeStyle = line.color;
                    appState.ctx.lineWidth = 4 * appState.mapScale; // ÊØî‰∏ªÁ∫øË∑ØÁªÜ
                    appState.ctx.stroke();
                    
                } else if (line.isExpress) {
                    console.log(`Â∫îÁî®ÁâπÂø´Á∫øÊ†∑ÂºèÂà∞Á∫øË∑Ø ${line.name}`);
                    
                    // ‰∏≠ÂõΩÈìÅË∑ØÁâπÂø´Á∫øÊ†∑ÂºèÔºöÊó†ÂúÜËßíÔºåÈªëËâ≤ÊèèËæπ
                    appState.ctx.lineCap = 'butt'; // Êó†ÂúÜËßí
                    
                    // Ê†πÊçÆÂú∞ÂõæÁº©ÊîæÊØî‰æãÂä®ÊÄÅË∞ÉÊï¥ËôöÁ∫øÊ†∑Âºè
                    const dashLength = 12 * appState.mapScale;
                    const gapLength = 8 * appState.mapScale;
                    
                    // Á¨¨‰∏ÄÊ≠•ÔºöÁªòÂà∂ÂÆåÊï¥ÁöÑÈªëËâ≤ËÉåÊôØÊèèËæπÔºàÂåÖÊã¨Á∫øÊÆµÂíåÈó¥ÈöôÔºâ
                    appState.ctx.setLineDash([]); // ÂÆûÁ∫øÁî®‰∫éËÉåÊôØÊèèËæπ
                    appState.ctx.strokeStyle = '#000000';
                    appState.ctx.lineWidth = 8 * appState.mapScale; // ÈªëËâ≤ÊèèËæπÂÆΩÂ∫¶
                    appState.ctx.stroke();
                    
                    // Á¨¨‰∫åÊ≠•ÔºöÁªòÂà∂ÁôΩËâ≤ËÉåÊôØÔºàÂåÖÊã¨Á∫øÊÆµÂíåÈó¥ÈöôÔºâ
                    appState.ctx.setLineDash([]); // ÂÆûÁ∫øÁî®‰∫éÁôΩËâ≤ËÉåÊôØ
                    appState.ctx.strokeStyle = '#FFFFFF';
                    appState.ctx.lineWidth = 6 * appState.mapScale; // ÁôΩËâ≤ËÉåÊôØÂÆΩÂ∫¶
                    appState.ctx.stroke();
                    
                    // Á¨¨‰∏âÊ≠•ÔºöÁªòÂà∂ÂΩ©Ëâ≤ËôöÁ∫øÁ∫øÊÆµ
                    appState.ctx.setLineDash([dashLength, gapLength]); // ËôöÁ∫øÊ†∑Âºè
                    appState.ctx.strokeStyle = line.color;
                    appState.ctx.lineWidth = 6 * appState.mapScale; // ÂΩ©Ëâ≤Á∫øÊù°ÂÆΩÂ∫¶
                    appState.ctx.stroke();
                    
                } else {
                    appState.ctx.lineCap = 'round';
                    appState.ctx.lineWidth = 4 * appState.mapScale;
                    appState.ctx.setLineDash([]); // ÂÆûÁ∫øÊ†∑Âºè
                    appState.ctx.stroke();
                }
            },

            // ÊòæÁ§∫Á∫øË∑ØÁºñÂè∑Ê†áÁ≠æ
            displayLineLabels(lines) {
                lines.forEach(line => {
                    if (line.stations.length > 1 && line.lineType !== 'walking') {
                        // ËÆ°ÁÆóÁ∫øË∑ØÁöÑÂá†‰Ωï‰∏≠ÁÇπÔºåËÄå‰∏çÊòØÁ´ôÁÇπ‰ΩçÁΩÆ
                        const startStation = line.stations[0];
                        const endStation = line.stations[line.stations.length - 1];
                        
                        // ËÆ°ÁÆóÁ∫øË∑ØÁöÑÂá†‰Ωï‰∏≠ÂøÉÁÇπ
                        const centerX = (startStation.X + endStation.X) / 2;
                        const centerY = (startStation.Y + endStation.Y) / 2;
                        
                        // Â∞Ü‰∏ñÁïåÂùêÊ†áËΩ¨Êç¢‰∏∫Â±èÂπïÂùêÊ†á
                        const centerScreenPos = this.worldToScreen(centerX, centerY);
                        
                        // ËÆæÁΩÆÊñáÂ≠óÊ†∑Âºè
                        appState.ctx.font = `${12 * appState.mapScale}px Arial`;
                        appState.ctx.textAlign = 'center';
                        appState.ctx.textBaseline = 'middle';
                        
                        // Ê∑ªÂä†ÁôΩËâ≤ÊèèËæπËÉåÊôØÔºåÊèêÈ´òÂèØËØªÊÄß
                        appState.ctx.strokeStyle = '#FFFFFF';
                        appState.ctx.lineWidth = 3 * appState.mapScale;
                        appState.ctx.strokeText(line.id, centerScreenPos.x, centerScreenPos.y);
                        
                        // ÁªòÂà∂‰∏éÁ∫øË∑ØÈ¢úËâ≤‰∏ÄËá¥ÁöÑÁºñÂè∑ÊñáÂ≠ó
                        appState.ctx.fillStyle = line.color;
                        appState.ctx.fillText(line.id, centerScreenPos.x, centerScreenPos.y);
                    }
                });
            },

            displayRoute(route, transfers) {
                transfers.forEach(transfer => {
                    const stations = transfer.stations.map(stationName => 
                        appState.stations.find(s => s.name === stationName)
                    ).filter(Boolean);
                    
                    if (stations.length > 1) {
                        appState.ctx.beginPath();
                        
                        stations.forEach((station, index) => {
                            const screenPos = this.worldToScreen(station.X, station.Y);
                            if (index === 0) {
                                appState.ctx.moveTo(screenPos.x, screenPos.y);
                            } else {
                                appState.ctx.lineTo(screenPos.x, screenPos.y);
                            }
                        });
                        
                        appState.ctx.strokeStyle = dataProcessor.getLineColor(transfer.line);
                        appState.ctx.lineWidth = 6 * appState.mapScale;
                        appState.ctx.setLineDash([5, 5]);
                        appState.ctx.stroke();
                        appState.ctx.setLineDash([]);
                    }
                });
            },

            render() {
                this.clearMap();
                
                // ËÆæÁΩÆÁôΩËâ≤ËÉåÊôØ
                appState.ctx.fillStyle = '#ffffff';
                appState.ctx.fillRect(0, 0, appState.canvas.width, appState.canvas.height);
                
                if (appState.lines.length > 0) {
                    // ‰ΩøÁî®Êñ∞ÁöÑÂ∏¶ËΩ¨ÊäòÁÇπÁöÑÁ∫øË∑ØÁªòÂà∂ÊñπÊ≥ï
                    this.displayLinesWithTurns(appState.lines);
                    this.displayLineLabels(appState.lines);
                    this.displayStations(appState.lines);
                }
            },

            // ÊòæÁ§∫ËäÇÁÇπËΩ¨ÊäòÁÇπ
            displayNodes() {
                if (appState.nodes && appState.nodes.length > 0) {
                    appState.nodes.forEach(node => {
                        const screenPos = this.worldToScreen(node.X, node.Y);
                        
                        // ÁªòÂà∂ËäÇÁÇπÊ†áËÆ∞
                        appState.ctx.beginPath();
                        appState.ctx.arc(screenPos.x, screenPos.y, 6 * appState.mapScale, 0, 2 * Math.PI);
                        appState.ctx.fillStyle = node.type === 'turn' ? '#FF6B6B' : '#4ECDC4';
                        appState.ctx.fill();
                        
                        // Ê∑ªÂä†ÁôΩËâ≤ËæπÊ°Ü
                        appState.ctx.strokeStyle = '#FFFFFF';
                        appState.ctx.lineWidth = 2 * appState.mapScale;
                        appState.ctx.stroke();
                        
                        // ÊòæÁ§∫ËäÇÁÇπÂêçÁß∞ÔºàÂèØÈÄâÔºâ
                        if (appState.mapScale > 0.5) {
                            appState.ctx.font = `${10 * appState.mapScale}px Arial`;
                            appState.ctx.fillStyle = '#333333';
                            appState.ctx.textAlign = 'center';
                            appState.ctx.textBaseline = 'top';
                            appState.ctx.fillText(node.name, screenPos.x, screenPos.y + 10 * appState.mapScale);
                        }
                    });
                }
            },

            // Ëá™Âä®Ê£ÄÊµãÂπ∂ÂàõÂª∫ËäÇÁÇπËΩ¨ÊäòÁÇπÔºà‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÂ§ÑÁêÜÔºâ
            detectAndCreateNodes(lines) {
                const nodes = [];
                const nodeMap = new Map(); // Áî®‰∫éÂéªÈáç
                
                lines.forEach(line => {
                    if (line.stations.length < 3) return; // Â∞ë‰∫é3‰∏™Á´ôÁÇπÊó†Ê≥ïÂΩ¢ÊàêËΩ¨Êäò
                    
                    // Ê£ÄÊµãÁ∫øË∑Ø‰∏äÁöÑËΩ¨ÊäòÁÇπ
                    const turnPoints = this.findTurnPoints(line);
                    
                    turnPoints.forEach(turnPoint => {
                        const station = turnPoint.station;
                        const nodeKey = `${station.X}_${station.Y}`;
                        
                        // ÈÅøÂÖçÈáçÂ§çËäÇÁÇπ
                        if (!nodeMap.has(nodeKey)) {
                            // Â∞ÜËäÇÁÇπ‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÂ§ÑÁêÜ
                            const node = {
                                id: `node_${nodes.length + 1}`,
                                name: `${station.name}_ËΩ¨ÊäòÁÇπ`,
                                X: station.X,
                                Y: station.Y,
                                type: 'node', // ÁâπÊÆäÁ±ªÂûãÔºöËäÇÁÇπ
                                originalStation: station.name,
                                line: line.name,
                                englishName: `${station.englishName || station.name}_TurnPoint`,
                                lineName: line.name
                            };
                            
                            nodes.push(node);
                            nodeMap.set(nodeKey, node);
                        }
                    });
                });
                
                return nodes;
            },

            // Âõæ‰æãÁõ∏ÂÖ≥ÂäüËÉΩ
            initLegend() {
                this.isLegendExpanded = true;
                this.updateLegend();
            },

            toggleLegend() {
                const legendContainer = document.getElementById('legendContainer');
                const toggleButton = legendContainer.querySelector('.legend-toggle');
                
                this.isLegendExpanded = !this.isLegendExpanded;
                
                if (this.isLegendExpanded) {
                    legendContainer.classList.remove('collapsed');
                    toggleButton.textContent = '‚ñº';
                    this.updateLegend();
                } else {
                    legendContainer.classList.add('collapsed');
                    toggleButton.textContent = '‚ñ∂';
                }
            },

            updateLegend() {
                if (!this.isLegendExpanded || !appState.lines || appState.lines.length === 0) return;
                
                const legendContent = document.getElementById('legendContent');
                legendContent.innerHTML = '';
                
                // ÊåâÁ∫øË∑ØÁ±ªÂûãÂàÜÁªÑÔºåËøáÊª§ÊéâÊ≠•Ë°åË∑Ø
                const linesByType = {};
                appState.lines.forEach(line => {
                    if (line.lineType === 'walking') return; // Ë∑≥ËøáÊ≠•Ë°åË∑Ø
                    if (!linesByType[line.lineType]) {
                        linesByType[line.lineType] = [];
                    }
                    linesByType[line.lineType].push(line);
                });
                
                // ÊåâÁâπÂÆöÈ°∫Â∫èÊòæÁ§∫Á∫øË∑ØÁ±ªÂûãÔºåÊéíÈô§Ê≠•Ë°åË∑Ø
                const typeOrder = ['subway', 'railway', 'bus'];
                
                typeOrder.forEach(type => {
                    if (linesByType[type]) {
                        linesByType[type].forEach(line => {
                            this.addLegendItem(line, legendContent);
                        });
                    }
                });
            },

            addLegendItem(line, container) {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                // Ê†πÊçÆÊòØÂê¶‰∏∫ÁâπÂø´Á∫øË∑ØÁ°ÆÂÆöÁ∫øË∑ØÁ±ªÂûã
                const typeName = line.isExpress ? 'Âø´Ëàπ' : 'ÈìÅË∑Ø';
                
                // Ëé∑ÂèñËµ∑ÁÇπÁ´ôÂíåÁªàÁÇπÁ´ô
                const startStation = line.stations[0]?.name || 'Êú™Áü•';
                const endStation = line.stations[line.stations.length - 1]?.name || 'Êú™Áü•';
                
                // Ëé∑ÂèñÁ∫øË∑ØÁâπÂæÅÊèèËø∞
                let features = '';
                if (line.branchOf) {
                    features += 'ÊîØÁ∫ø';
                }
                
                legendItem.innerHTML = `
                    <div class="legend-color" style="background-color: ${line.color}"></div>
                    <div class="legend-info">
                        <div class="legend-line-name">${line.name}</div>
                        <div class="legend-line-details">
                            <span class="legend-line-type">${typeName}</span>
                            ${features ? `<span>${features}</span>` : ''}
                        </div>
                        <div class="legend-stations">${startStation} ‚Üî ${endStation}</div>
                    </div>
                `;
                
                container.appendChild(legendItem);
            },

            // Âú®Canvas‰∏äÁªòÂà∂Âõæ‰æãÔºàÁî®‰∫éÂõæÁâá‰øùÂ≠òÔºâ
            drawLegendOnCanvas(ctx, scale) {
                if (!appState.lines || appState.lines.length === 0) return;
                
                // ËøáÊª§ÊéâÊ≠•Ë°åË∑ØÁ∫øË∑Ø
                const filteredLines = appState.lines.filter(line => line.lineType !== 'walking');
                if (filteredLines.length === 0) return;
                
                // Âõæ‰æãÈ°πÂèÇÊï∞
                const itemWidth = 250 * scale;
                const itemHeight = 80 * scale;
                const padding = 20 * scale;
                const spacing = 15 * scale;
                
                // ËÆ°ÁÆóÊØèË°åÊúÄÂ§öËÉΩÂÆπÁ∫≥ÁöÑÂõæ‰æãÈ°πÊï∞Èáè
                const maxItemsPerRow = Math.floor((ctx.canvas.width - padding * 2) / (itemWidth + spacing));
                const rows = Math.ceil(filteredLines.length / maxItemsPerRow);
                
                // ËÆ°ÁÆóÂõæ‰æãÊÄªÈ´òÂ∫¶Âíå‰ΩçÁΩÆ
                const totalHeight = rows * itemHeight + (rows - 1) * spacing;
                const legendY = ctx.canvas.height - (totalHeight + 50 * scale); // Â∫ïÈÉ®ÁïôÂá∫50ÂÉèÁ¥†Èó¥Ë∑ù
                
                // ÁªòÂà∂Âõæ‰æãËÉåÊôØ
                ctx.fillStyle = 'rgba(255, 255, 255, 0.9)';
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.2)';
                ctx.lineWidth = 1 * scale;
                ctx.fillRect(padding, legendY - padding, 
                           ctx.canvas.width - padding * 2, totalHeight + padding * 2);
                ctx.strokeRect(padding, legendY - padding, 
                             ctx.canvas.width - padding * 2, totalHeight + padding * 2);
                
                // ÁªòÂà∂Âõæ‰æãÊ†áÈ¢ò
                ctx.font = `${16 * scale}px Arial`;
                ctx.fillStyle = '#2c3e50';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'top';
                ctx.fillText('Á∫øË∑ØÂõæ‰æã', ctx.canvas.width / 2, legendY - padding - 25 * scale);
                
                // ÁªòÂà∂ÊØèÊù°Á∫øË∑ØÁöÑÂõæ‰æãÈ°πÔºàËá™Âä®Êç¢Ë°åÔºåÂ∑¶ÂØπÈΩêÔºâ
                filteredLines.forEach((line, index) => {
                    const row = Math.floor(index / maxItemsPerRow);
                    const col = index % maxItemsPerRow;
                    
                    // ËÆ°ÁÆóÊØèË°åÁöÑËµ∑Âßã‰ΩçÁΩÆÔºàÂ∑¶ÂØπÈΩêÔºâ
                    const rowStartX = padding;
                    
                    const itemX = rowStartX + col * (itemWidth + spacing);
                    const itemY = legendY + row * (itemHeight + spacing);
                    
                    // ÁªòÂà∂È¢úËâ≤Âùó
                    ctx.fillStyle = line.color;
                    ctx.fillRect(itemX, itemY, 20 * scale, 20 * scale);
                    
                    // ÁªòÂà∂Á∫øË∑ØÂêçÁß∞
                    ctx.font = `${14 * scale}px Arial`;
                    ctx.fillStyle = '#2c3e50';
                    ctx.textAlign = 'left';
                    ctx.fillText(line.name, itemX + 25 * scale, itemY);
                    
                    // ÁªòÂà∂Á∫øË∑ØÁ±ªÂûãÂíåÁâπÂæÅ
                    ctx.font = `${12 * scale}px Arial`;
                    ctx.fillStyle = '#666';
                    
                    // Ê†πÊçÆÊòØÂê¶‰∏∫ÁâπÂø´Á∫øË∑ØÁ°ÆÂÆöÁ∫øË∑ØÁ±ªÂûã
                    const typeName = line.isExpress ? 'Âø´Ëàπ' : 'ÈìÅË∑Ø';
                    let features = '';
                    if (line.branchOf) features += 'ÊîØÁ∫ø';
                    
                    ctx.fillText(`${typeName}${features ? ` - ${features}` : ''}`, 
                               itemX + 25 * scale, itemY + 20 * scale);
                    
                    // ÁªòÂà∂Ëµ∑ÁÇπÁªàÁÇπ
                    const startStation = line.stations[0]?.name || 'Êú™Áü•';
                    const endStation = line.stations[line.stations.length - 1]?.name || 'Êú™Áü•';
                    ctx.fillText(`${startStation} ‚Üî ${endStation}`, 
                               itemX + 25 * scale, itemY + 40 * scale);
                });
            }

        };

        // ‰∫ã‰ª∂Â§ÑÁêÜÂáΩÊï∞
        window.eventHandlers = {
            init() {
                // ÂàùÂßãÂåñÂú∞Âõæ
                mapRenderer.init();
                
                // ÂàùÂßãÂåñÂõæ‰æã
                mapRenderer.initLegend();
                
                // ÁªëÂÆö‰∫ã‰ª∂Ôºà‰ΩøÁî®ÁÆ≠Â§¥ÂáΩÊï∞‰øùÊåÅÊ≠£Á°ÆÁöÑthis‰∏ä‰∏ãÊñáÔºâ
                document.getElementById('calculateRoute').addEventListener('click', () => this.handleRouteCalculation());
                document.getElementById('zoomIn').addEventListener('click', () => this.handleZoomIn());
                document.getElementById('zoomOut').addEventListener('click', () => this.handleZoomOut());
                document.getElementById('resetView').addEventListener('click', () => this.handleResetView());
                document.getElementById('saveImage').addEventListener('click', () => this.handleSaveImage());
                
                // ÁªëÂÆöÊêúÁ¥¢ÂäüËÉΩ‰∫ã‰ª∂
                this.initSearchFunctionality();
                
                // ÂêØÂä®Êó∂ÈùôÈªòÂä†ËΩΩÁ§∫‰æãÊï∞ÊçÆ
                setTimeout(() => {
                    this.handleLoadSampleSilent();
                }, 100);
            },

            initSearchFunctionality() {
                // ÊêúÁ¥¢Ê°ÜÂ∑≤Ë¢´Âà†Èô§ÔºåÊ≠§ÂáΩÊï∞Áé∞Âú®Âè™‰øùÁïôÁ©∫ÂÆûÁé∞
                // ÂèØÊêúÁ¥¢‰∏ãÊãâÊ°ÜÁöÑÂàùÂßãÂåñÂú®Êï∞ÊçÆÂä†ËΩΩÂÆåÊàêÂêéË∞ÉÁî®
            },
            
            initSearchableSelects() {
                // ‰∏∫Ëµ∑ÁÇπÁ´ôÂíåÁªàÁÇπÁ´ôÂàùÂßãÂåñÂèØÊêúÁ¥¢‰∏ãÊãâÊ°Ü
                this.initSearchableSelect('startStation');
                this.initSearchableSelect('endStation');
            },
            
            initSearchableSelect(selectId) {
                const originalSelect = document.getElementById(selectId);
                const searchableSelect = document.querySelector(`.searchable-select[data-for="${selectId}"]`);
                const searchInput = searchableSelect.querySelector('.searchable-select-input');
                const optionsContainer = searchableSelect.querySelector('.searchable-select-options');
                
                // ÂàùÂßãÂåñÈÄâÈ°π
                this.populateSearchableOptions(selectId);
                
                // ÊêúÁ¥¢ËæìÂÖ•‰∫ã‰ª∂
                searchInput.addEventListener('input', (e) => {
                    const query = e.target.value.trim().toLowerCase();
                    const options = optionsContainer.querySelectorAll('.searchable-select-option');
                    
                    options.forEach(option => {
                        const text = option.textContent.toLowerCase();
                        if (text.includes(query)) {
                            option.style.display = 'block';
                        } else {
                            option.style.display = 'none';
                        }
                    });
                    
                    // ÊòæÁ§∫ÈÄâÈ°πÂÆπÂô®
                    optionsContainer.style.display = 'block';
                });
                
                // ÁÇπÂáªÈÄâÈ°π‰∫ã‰ª∂
                optionsContainer.addEventListener('click', (e) => {
                    const option = e.target.closest('.searchable-select-option');
                    if (option) {
                        const value = option.dataset.value;
                        // ‰ªéÈÄâÈ°πÁöÑHTMLÂÜÖÂÆπ‰∏≠ÊèêÂèñÁ´ôÁÇπÂêçÁß∞ÔºàÁ¨¨‰∏Ä‰∏™divÁöÑÂÜÖÂÆπÔºâ
                        const stationName = option.querySelector('.search-result-name')?.textContent || option.textContent;
                        
                        // Êõ¥Êñ∞ÊêúÁ¥¢ËæìÂÖ•Ê°ÜÊòæÁ§∫ÔºàÂè™ÊòæÁ§∫Á´ôÁÇπÂêçÁß∞Ôºâ
                        searchInput.value = stationName;
                        
                        // Êõ¥Êñ∞ÂéüÂßãselectÂÖÉÁ¥†
                        originalSelect.value = value;
                        
                        // ÈöêËóèÈÄâÈ°πÂÆπÂô®
                        optionsContainer.style.display = 'none';
                        
                        // ÊòæÁ§∫ÊàêÂäüÊ∂àÊÅØ
                        utils.showNotification(`Â∑≤ÈÄâÊã©Á´ôÁÇπÔºö${stationName}`);
                    }
                });
                
                // ÁÇπÂáªÂ§ñÈÉ®ÂÖ≥Èó≠ÈÄâÈ°πÂÆπÂô®
                document.addEventListener('click', (e) => {
                    if (!searchableSelect.contains(e.target)) {
                        optionsContainer.style.display = 'none';
                    }
                });
                
                // ÊêúÁ¥¢Ê°ÜËÅöÁÑ¶Êó∂ÊòæÁ§∫ÊâÄÊúâÈÄâÈ°π
                searchInput.addEventListener('focus', () => {
                    const options = optionsContainer.querySelectorAll('.searchable-select-option');
                    options.forEach(option => option.style.display = 'block');
                    optionsContainer.style.display = 'block';
                });
                
                // ÁõëÂê¨ÂéüÂßãselectÂèòÂåñÔºåÂêåÊ≠•Âà∞ÊêúÁ¥¢ËæìÂÖ•Ê°Ü
                originalSelect.addEventListener('change', () => {
                    const selectedOption = originalSelect.options[originalSelect.selectedIndex];
                    if (selectedOption) {
                        searchInput.value = selectedOption.text;
                    }
                    
                    // Ê£ÄÊü•ÊòØÂê¶Ëµ∑ÁÇπÂíåÁªàÁÇπÈÉΩÂ∑≤ÈÄâÊã©ÔºåÂ¶ÇÊûúÊòØÂàôËá™Âä®ËÆ°ÁÆóË∑ØÂæÑ
                    eventHandlers.autoCalculateRoute();
                });
            },
            
            populateSearchableOptions(selectId) {
                const originalSelect = document.getElementById(selectId);
                const searchableSelect = document.querySelector(`.searchable-select[data-for="${selectId}"]`);
                const optionsContainer = searchableSelect.querySelector('.searchable-select-options');
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π
                optionsContainer.innerHTML = '';
                
                // Ê∑ªÂä†ÊâÄÊúâÈÄâÈ°πÔºåÊòæÁ§∫ÂèåËØ≠ÂíåÁ∫øË∑Ø‰ø°ÊÅØ
                for (let i = 0; i < originalSelect.options.length; i++) {
                    const option = originalSelect.options[i];
                    if (option.value) {
                        // Ëß£ÊûêÁ´ôÁÇπÂêçÁß∞ÂíåÁ∫øË∑Ø‰ø°ÊÅØ
                        const stationName = option.text;
                        const valueParts = option.value.split('_');
                        const lineId = valueParts.length > 1 ? valueParts[1] : '';
                        
                        // Êü•ÊâæÁ´ôÁÇπËØ¶ÁªÜ‰ø°ÊÅØ
                        const station = appState.stations.find(s => s.name === stationName && s.line === lineId);
                        
                        const optionElement = document.createElement('div');
                        optionElement.className = 'searchable-select-option';
                        optionElement.dataset.value = option.value;
                        
                        if (station && station.englishName) {
                            // ÊòæÁ§∫ÂèåËØ≠ÂíåÁ∫øË∑Ø‰ø°ÊÅØ
                            optionElement.innerHTML = `
                                <div class="search-result-name">${stationName}</div>
                                <div class="search-result-line">${station.englishName} - ${station.lineName || station.line}</div>
                            `;
                        } else {
                            // Â¶ÇÊûúÊ≤°ÊúâËã±ÊñáÂêçÔºåÂè™ÊòæÁ§∫Á´ôÁÇπÂêçÁß∞ÂíåÁ∫øË∑Ø
                            optionElement.innerHTML = `
                                <div class="search-result-name">${stationName}</div>
                                <div class="search-result-line">${stationName} - ${lineId}</div>
                            `;
                        }
                        
                        optionsContainer.appendChild(optionElement);
                    }
                }
            },

            handleFileImport(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                const self = this; // ‰øùÂ≠òÊ≠£Á°ÆÁöÑthisÂºïÁî®
                reader.onload = function(e) {
                    try {
                        const fileContent = e.target.result;
                        let data = {};
                        
                        if (file.name.endsWith('.csv')) {
                            data = dataProcessor.parseCSVData(fileContent);
                        } else if (file.name.endsWith('.json')) {
                            // JSONÊ†ºÂºèÂèØËÉΩËøîÂõûÊï∞ÁªÑÔºåÈúÄË¶ÅËΩ¨Êç¢‰∏∫Êñ∞ÁöÑÊï∞ÊçÆÁªìÊûÑ
                            const stations = dataProcessor.parseJSONData(fileContent);
                            data = {
                                lines: dataProcessor.groupStationsByLine(stations),
                                stations: stations
                            };
                        } else {
                            throw new Error('‰∏çÊîØÊåÅÁöÑÊñá‰ª∂Ê†ºÂºè');
                        }
                        
                        if (data.stations.length === 0) {
                            throw new Error('Êú™ÊâæÂà∞ÊúâÊïàÁöÑÁ´ôÁÇπÊï∞ÊçÆ');
                        }
                        
                        // Â§ÑÁêÜÊï∞ÊçÆ
                        appState.stations = data.stations;
                        appState.lines = data.lines;
                        
                        // Ëá™Âä®Ê£ÄÊµãÂπ∂Ê∑ªÂä†ËäÇÁÇπËΩ¨ÊäòÁÇπÔºà‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÂ§ÑÁêÜÔºâ
                        const detectedNodes = this.detectAndCreateNodes(data.lines);
                        
                        // Â∞ÜËäÇÁÇπÂêàÂπ∂Âà∞Á´ôÁÇπÊï∞ÁªÑ‰∏≠
                        appState.stations = [...data.stations, ...detectedNodes];
                        
                        // ÈáçÊñ∞ÊûÑÂª∫ÂõæÔºàÂåÖÂê´ËäÇÁÇπÔºâ
                        appState.graph = routePlanner.buildGraph(data.lines);
                        
                        // Êõ¥Êñ∞UI
                        mapRenderer.clearMap();
                        mapRenderer.render();
                        
                        // Êõ¥Êñ∞Á´ôÁÇπÈÄâÊã©‰∏ãÊãâËèúÂçï
                        self.updateStationSelects();
                        
                        utils.showNotification(`ÊàêÂäüÂØºÂÖ• ${data.stations.length} ‰∏™Á´ôÁÇπÊï∞ÊçÆÔºåÊ£ÄÊµãÂà∞ ${detectedNodes.length} ‰∏™ËΩ¨ÊäòÁÇπ`);
                        
                    } catch (error) {
                        utils.showNotification(error.message, 'error');
                        console.error('Êñá‰ª∂ÂØºÂÖ•ÈîôËØØ:', error);
                    }
                };
                
                reader.readAsText(file);
            },

            updateStationSelects() {
                const startSelect = document.getElementById('startStation');
                const endSelect = document.getElementById('endStation');
                
                // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°πÔºà‰øùÁïôÁ¨¨‰∏Ä‰∏™ÈÄâÈ°πÔºâ
                while (startSelect.options.length > 1) startSelect.remove(1);
                while (endSelect.options.length > 1) endSelect.remove(1);
                
                // ‰ΩøÁî®SetÊù•ÂéªÈáçÔºåÂè™ÊòæÁ§∫ÂîØ‰∏ÄÁöÑÁ´ôÁÇπÂêçÁß∞
                const uniqueStationNames = [...new Set(appState.stations.map(station => station.name))];
                
                // Ê∑ªÂä†ÂéªÈáçÂêéÁöÑÁ´ôÁÇπÈÄâÈ°π
                uniqueStationNames.forEach(stationName => {
                    // Êü•ÊâæËØ•Á´ôÁÇπÁöÑÁ¨¨‰∏Ä‰∏™Á∫øË∑Ø‰Ωú‰∏∫ÈªòËÆ§ÂÄº
                    const firstStation = appState.stations.find(station => station.name === stationName);
                    const value = `${stationName}_${firstStation.line}`;
                    const option1 = new Option(stationName, value);
                    const option2 = new Option(stationName, value);
                    startSelect.add(option1);
                    endSelect.add(option2);
                });
                
                // Êõ¥Êñ∞ÂèØÊêúÁ¥¢‰∏ãÊãâÊ°ÜÁöÑÈÄâÈ°π
                if (typeof this.populateSearchableOptions === 'function') {
                    this.populateSearchableOptions('startStation');
                    this.populateSearchableOptions('endStation');
                }
            },

            handleClearMap() {
                appState.stations = [];
                appState.lines = [];
                appState.graph = null;
                mapRenderer.clearMap();
                

                
                const routeInfo = document.getElementById('routeInfo');
                routeInfo.innerHTML = '<p>ËØ∑ÈÄâÊã©Ëµ∑ÁÇπÂíåÁªàÁÇπÁ´ôËøõË°åË∑ØÂæÑËßÑÂàí</p>';
                
                const transferInfo = document.getElementById('transferInfo');
                transferInfo.innerHTML = '<p>Ë∑ØÂæÑËßÑÂàíÂÆåÊàêÂêéÊòæÁ§∫Êç¢‰πò‰ø°ÊÅØ</p>';
                
                this.updateStationSelects();
                utils.showNotification('Âú∞ÂõæÂ∑≤Ê∏ÖÈô§');
            },

            handleLoadSample() {
                try {
                    console.log('ÂºÄÂßãÂä†ËΩΩÂú∞ÈìÅÊï∞ÊçÆ...');
                    
                    // ‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáèsubwayDataÂíåstationCoordinatesÔºåËØ•ÂèòÈáèÂú®subway-data.jsÊñá‰ª∂‰∏≠ÂÆö‰πâ
                    if (typeof subwayData === 'undefined' || typeof stationCoordinates === 'undefined') {
                        throw new Error('Âú∞ÈìÅÊï∞ÊçÆÊú™Âä†ËΩΩÔºåËØ∑Á°Æ‰øùsubway-data.jsÊñá‰ª∂Â∑≤Ê≠£Á°ÆÂºïÂÖ•');
                    }
                    
                    // Ëß£ÊûêÂú∞ÈìÅÁ∫øË∑ØÊï∞ÊçÆ
                    const subwayLinesData = dataProcessor.parseLineData(subwayData);
                    console.log('Ëß£ÊûêÂêéÁöÑÂú∞ÈìÅÁ∫øË∑ØÊï∞ÊçÆ:', subwayLinesData);
                    
                    // Ê£ÄÊü•ÁâπÂø´Á∫øÂ≠óÊÆµ
                    subwayLinesData.forEach(line => {
                        console.log(`Âú∞ÈìÅÁ∫øË∑Ø ${line.lineName} - isExpress: ${line.isExpress}, Á±ªÂûã: ${typeof line.isExpress}`);
                    });
                    
                    // Ëß£ÊûêÂú∞ÈìÅÁ´ôÁÇπÂùêÊ†áÊï∞ÊçÆ
                    const subwayStationsData = dataProcessor.parseStationData(stationCoordinates);
                    console.log('Ëß£ÊûêÂêéÁöÑÂú∞ÈìÅÁ´ôÁÇπÊï∞ÊçÆ:', subwayStationsData);
                    
                    // ÂêàÂπ∂Âú∞ÈìÅÊï∞ÊçÆ
                    const subwayCombinedData = dataProcessor.combineLineAndStationData(subwayLinesData, subwayStationsData);
                    console.log('ÂêàÂπ∂ÂêéÁöÑÂú∞ÈìÅÊï∞ÊçÆ:', subwayCombinedData);
                    
                    // Ê£ÄÊü•ÂêàÂπ∂ÂêéÁöÑÁâπÂø´Á∫ø‰ø°ÊÅØ
                    subwayCombinedData.lines.forEach(line => {
                        console.log(`ÂêàÂπ∂ÂêéÂú∞ÈìÅÁ∫øË∑Ø ${line.name} - isExpress: ${line.isExpress}, Á±ªÂûã: ${typeof line.isExpress}`);
                    });
                    
                    // ÂàùÂßãÂåñÂ∫îÁî®Áä∂ÊÄÅ
                    appState.stations = [...subwayCombinedData.stations];
                    appState.lines = [...subwayCombinedData.lines];
                    
                    // Â¶ÇÊûúÂ≠òÂú®Ê≠•Ë°åË∑ØÊï∞ÊçÆÔºåÂä†ËΩΩÂπ∂ÂêàÂπ∂
                    if (typeof walkingData !== 'undefined') {
                        console.log('ÂºÄÂßãÂä†ËΩΩÊ≠•Ë°åË∑ØÊï∞ÊçÆ...');
                        
                        // Ëß£ÊûêÊ≠•Ë°åË∑ØÁ∫øË∑ØÊï∞ÊçÆ
                        const walkingLinesData = dataProcessor.parseLineData(walkingData);
                        console.log('Ëß£ÊûêÂêéÁöÑÊ≠•Ë°åË∑ØÁ∫øË∑ØÊï∞ÊçÆ:', walkingLinesData);
                        
                        // Ê≠•Ë°åË∑ØÁ´ôÁÇπÁõ¥Êé•Ë∞ÉÁî®subway-data.js‰∏≠ÁöÑÁ´ôÁÇπÊï∞ÊçÆ
                        // ‰ΩøÁî®Âú∞ÈìÅÁ´ôÁÇπÊï∞ÊçÆ‰Ωú‰∏∫Ê≠•Ë°åË∑ØÁ´ôÁÇπÁöÑÂùêÊ†áÊù•Ê∫ê
                        const walkingCombinedData = dataProcessor.combineLineAndStationData(walkingLinesData, subwayStationsData);
                        console.log('ÂêàÂπ∂ÂêéÁöÑÊ≠•Ë°åË∑ØÊï∞ÊçÆ:', walkingCombinedData);
                        
                        // ÂêàÂπ∂Âà∞Â∫îÁî®Áä∂ÊÄÅ
                        appState.stations = [...appState.stations, ...walkingCombinedData.stations];
                        appState.lines = [...appState.lines, ...walkingCombinedData.lines];
                        
                        console.log(`ÊàêÂäüÂä†ËΩΩ ${walkingCombinedData.lines.length} Êù°Ê≠•Ë°åË∑ØÁ∫øË∑Ø`);
                    }
                    
                    // Ëß£ÊûêÂπ∂Ê∑ªÂä†ËäÇÁÇπÊï∞ÊçÆÔºà‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÂ§ÑÁêÜÔºâ
                    if (typeof nodeData !== 'undefined') {
                        console.log('ÂºÄÂßãËß£ÊûêËäÇÁÇπÊï∞ÊçÆ...');
                        const parsedNodes = dataProcessor.parseNodeData(nodeData);
                        console.log('Ëß£ÊûêÂêéÁöÑËäÇÁÇπÊï∞ÊçÆ:', parsedNodes);
                        
                        // Â∞ÜËäÇÁÇπÊèíÂÖ•Âà∞Á∫øË∑ØÁ´ôÁÇπÂ∫èÂàó‰∏≠
                        dataProcessor.insertNodesIntoLineSequences(appState.lines, parsedNodes);
                        
                        // Â∞ÜËäÇÁÇπÂêàÂπ∂Âà∞Á´ôÁÇπÊï∞ÁªÑ‰∏≠
                        appState.stations = [...appState.stations, ...parsedNodes];
                        console.log(`ÊàêÂäüÂä†ËΩΩ ${parsedNodes.length} ‰∏™ËäÇÁÇπÊï∞ÊçÆ`);
                    }
                    
                    appState.graph = routePlanner.buildGraph(appState.lines);
                    
                    console.log('Â∫îÁî®Áä∂ÊÄÅÊõ¥Êñ∞ÂÆåÊàê:', {
                        stations: appState.stations.length,
                        lines: appState.lines.length,
                        graph: appState.graph ? 'Â∑≤ÊûÑÂª∫' : 'Êú™ÊûÑÂª∫'
                    });
                    
                    // Êõ¥Êñ∞UI
                    mapRenderer.clearMap();
                    mapRenderer.render();
                    
                    // ËÆæÁΩÆÂú∞Âõæ‰∏≠ÂøÉ‰∏∫ÊóßÂõ≠Á´ô
                    const jiuyuanStation = appState.stations.find(station => station.name === 'ÊóßÂõ≠');
                    if (jiuyuanStation) {
                        // ËÆ°ÁÆóÊóßÂõ≠Á´ôÁöÑÂ±èÂπïÂùêÊ†á
                        const screenPos = mapRenderer.worldToScreen(jiuyuanStation.X, jiuyuanStation.Y);
                        const canvasCenterX = appState.canvas.width / 2;
                        const canvasCenterY = appState.canvas.height / 2;
                        
                        // ËÆæÁΩÆÂú∞ÂõæÂÅèÁßªÈáèÔºå‰ΩøÊóßÂõ≠Á´ô‰Ωç‰∫éÂ±èÂπï‰∏≠ÂøÉ
                        appState.mapOffset.x = canvasCenterX - screenPos.x;
                        appState.mapOffset.y = canvasCenterY - screenPos.y;
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
                        mapRenderer.render();
                    }
                    
                    // Êõ¥Êñ∞Á´ôÁÇπÈÄâÊã©‰∏ãÊãâËèúÂçï
                    this.updateStationSelects();
                    
                    // ÂàùÂßãÂåñÂèØÊêúÁ¥¢‰∏ãÊãâÊ°Ü
                    if (typeof this.initSearchableSelects === 'function') {
                        this.initSearchableSelects();
                    }
                    
                    // Êõ¥Êñ∞Âõæ‰æã
                    if (typeof mapRenderer.updateLegend === 'function') {
                        mapRenderer.updateLegend();
                    }
                    
                    console.log('subway-data.jsÊï∞ÊçÆÂä†ËΩΩÂÆåÊàê');
                    utils.showNotification(`ÊàêÂäüÂä†ËΩΩ ${appState.stations.length} ‰∏™Á´ôÁÇπÊï∞ÊçÆ`);
                    
                } catch (error) {
                    console.error('Êï∞ÊçÆÂä†ËΩΩÈîôËØØ:', error);
                    utils.showNotification('Êï∞ÊçÆÂä†ËΩΩÂ§±Ë¥•: ' + error.message, 'error');
                }
            },

            handleLoadSampleSilent() {
                try {
                    console.log('ÂºÄÂßãÈùôÈªòÂä†ËΩΩÂú∞ÈìÅÊï∞ÊçÆ...');
                    
                    // ‰ΩøÁî®ÂÖ®Â±ÄÂèòÈáèsubwayDataÂíåstationCoordinatesÔºåËØ•ÂèòÈáèÂú®subway-data.jsÊñá‰ª∂‰∏≠ÂÆö‰πâ
                    if (typeof subwayData === 'undefined' || typeof stationCoordinates === 'undefined') {
                        console.error('Âú∞ÈìÅÊï∞ÊçÆÊú™Âä†ËΩΩÔºåËØ∑Á°Æ‰øùsubway-data.jsÊñá‰ª∂Â∑≤Ê≠£Á°ÆÂºïÂÖ•');
                        return;
                    }
                    
                    // Ëß£ÊûêÂú∞ÈìÅÁ∫øË∑ØÊï∞ÊçÆ
                    const subwayLinesData = dataProcessor.parseLineData(subwayData);
                    
                    // Ëß£ÊûêÂú∞ÈìÅÁ´ôÁÇπÂùêÊ†áÊï∞ÊçÆ
                    const subwayStationsData = dataProcessor.parseStationData(stationCoordinates);
                    
                    // ÂêàÂπ∂Âú∞ÈìÅÊï∞ÊçÆ
                    const subwayCombinedData = dataProcessor.combineLineAndStationData(subwayLinesData, subwayStationsData);
                    
                    // ÂàùÂßãÂåñÂ∫îÁî®Áä∂ÊÄÅ
                    appState.stations = [...subwayCombinedData.stations];
                    appState.lines = [...subwayCombinedData.lines];
                    
                    // Â¶ÇÊûúÂ≠òÂú®Ê≠•Ë°åË∑ØÊï∞ÊçÆÔºåÂä†ËΩΩÂπ∂ÂêàÂπ∂
                    if (typeof walkingData !== 'undefined') {
                        // Ëß£ÊûêÊ≠•Ë°åË∑ØÁ∫øË∑ØÊï∞ÊçÆ
                        const walkingLinesData = dataProcessor.parseLineData(walkingData);
                        
                        // Ê≠•Ë°åË∑ØÁ´ôÁÇπÁõ¥Êé•Ë∞ÉÁî®subway-data.js‰∏≠ÁöÑÁ´ôÁÇπÊï∞ÊçÆ
                        const walkingCombinedData = dataProcessor.combineLineAndStationData(walkingLinesData, subwayStationsData);
                        
                        // ÂêàÂπ∂Âà∞Â∫îÁî®Áä∂ÊÄÅ
                        appState.stations = [...appState.stations, ...walkingCombinedData.stations];
                        appState.lines = [...appState.lines, ...walkingCombinedData.lines];
                    }
                    
                    // Ëß£ÊûêÂπ∂Ê∑ªÂä†ËäÇÁÇπÊï∞ÊçÆÔºà‰Ωú‰∏∫ÁâπÊÆäÁ´ôÁÇπÂ§ÑÁêÜÔºâ
                    if (typeof nodeData !== 'undefined') {
                        console.log('ÂºÄÂßãÈùôÈªòËß£ÊûêËäÇÁÇπÊï∞ÊçÆ...');
                        const parsedNodes = dataProcessor.parseNodeData(nodeData);
                        
                        // Â∞ÜËäÇÁÇπÊèíÂÖ•Âà∞Á∫øË∑ØÁ´ôÁÇπÂ∫èÂàó‰∏≠
                        dataProcessor.insertNodesIntoLineSequences(appState.lines, parsedNodes);
                        
                        // Â∞ÜËäÇÁÇπÂêàÂπ∂Âà∞Á´ôÁÇπÊï∞ÁªÑ‰∏≠
                        appState.stations = [...appState.stations, ...parsedNodes];
                        console.log(`ÈùôÈªòÂä†ËΩΩ ${parsedNodes.length} ‰∏™ËäÇÁÇπÊï∞ÊçÆ`);
                    }
                    
                    appState.graph = routePlanner.buildGraph(appState.lines);
                    
                    console.log('ÈùôÈªòÂä†ËΩΩÂ∫îÁî®Áä∂ÊÄÅÊõ¥Êñ∞ÂÆåÊàê:', {
                        stations: appState.stations.length,
                        lines: appState.lines.length,
                        graph: appState.graph ? 'Â∑≤ÊûÑÂª∫' : 'Êú™ÊûÑÂª∫'
                    });
                    
                    // Êõ¥Êñ∞UI
                    mapRenderer.clearMap();
                    mapRenderer.render();
                    
                    // ËÆæÁΩÆÂú∞Âõæ‰∏≠ÂøÉ‰∏∫ÊóßÂõ≠Á´ô
                    const jiuyuanStation = appState.stations.find(station => station.name === 'ÊóßÂõ≠');
                    if (jiuyuanStation) {
                        // ËÆ°ÁÆóÊóßÂõ≠Á´ôÁöÑÂ±èÂπïÂùêÊ†á
                        const screenPos = mapRenderer.worldToScreen(jiuyuanStation.X, jiuyuanStation.Y);
                        const canvasCenterX = appState.canvas.width / 2;
                        const canvasCenterY = appState.canvas.height / 2;
                        
                        // ËÆæÁΩÆÂú∞ÂõæÂÅèÁßªÈáèÔºå‰ΩøÊóßÂõ≠Á´ô‰Ωç‰∫éÂ±èÂπï‰∏≠ÂøÉ
                        appState.mapOffset.x = canvasCenterX - screenPos.x;
                        appState.mapOffset.y = canvasCenterY - screenPos.y;
                        
                        // ÈáçÊñ∞Ê∏≤ÊüìÂú∞Âõæ
                        mapRenderer.render();
                    }
                    
                    // Êõ¥Êñ∞Á´ôÁÇπÈÄâÊã©‰∏ãÊãâËèúÂçï
                    this.updateStationSelects();
                    
                    // ÂàùÂßãÂåñÂèØÊêúÁ¥¢‰∏ãÊãâÊ°Ü
                    if (typeof this.initSearchableSelects === 'function') {
                        this.initSearchableSelects();
                    }
                    
                    console.log('subway-data.jsÊï∞ÊçÆÈùôÈªòÂä†ËΩΩÂÆåÊàê');
                    
                } catch (error) {
                    console.error('Êï∞ÊçÆÈùôÈªòÂä†ËΩΩÈîôËØØ:', error);
                }
            },

            autoCalculateRoute() {
                const startStation = document.getElementById('startStation').value;
                const endStation = document.getElementById('endStation').value;
                
                // Âè™ÊúâÂΩìËµ∑ÁÇπÂíåÁªàÁÇπÈÉΩÂ∑≤ÈÄâÊã©Êó∂ÊâçËá™Âä®ËÆ°ÁÆóË∑ØÂæÑ
                if (startStation && endStation && startStation !== endStation) {
                    this.handleRouteCalculation();
                }
            },

            handleRouteCalculation() {
                const startStation = document.getElementById('startStation').value;
                const endStation = document.getElementById('endStation').value;
                
                if (!startStation || !endStation) {
                    utils.showNotification('ËØ∑ÈÄâÊã©Ëµ∑ÁÇπÂíåÁªàÁÇπÁ´ô', 'error');
                    return;
                }
                
                if (startStation === endStation) {
                    utils.showNotification('Ëµ∑ÁÇπÂíåÁªàÁÇπ‰∏çËÉΩÁõ∏Âêå', 'error');
                    return;
                }
                
                if (!appState.graph) {
                    utils.showNotification('ËØ∑ÂÖàÂØºÂÖ•Á∫øË∑ØÊï∞ÊçÆ', 'error');
                    return;
                }
                
                try {
                    // ËÆ°ÁÆóË∑ØÂæÑ
                    const route = routePlanner.dijkstra(appState.graph, startStation, endStation);
                    
                    if (route.distance === Infinity) {
                        utils.showNotification('Êó†Ê≥ïÊâæÂà∞‰ªéËµ∑ÁÇπÂà∞ÁªàÁÇπÁöÑË∑ØÂæÑ', 'error');
                        return;
                    }
                    
                    // ÂàÜÊûêÊç¢‰πò‰ø°ÊÅØ
                    const transfers = routePlanner.analyzeTransfers(route, appState.lines);
                    
                    // ÊòæÁ§∫Ë∑ØÁ∫ø
                    mapRenderer.displayRoute(route, transfers);
                    
                    // Êõ¥Êñ∞UI‰ø°ÊÅØ
                    const routeInfo = document.getElementById('routeInfo');
                    routeInfo.innerHTML = `
                        <p><strong>Ë∑ØÂæÑËßÑÂàíÂÆåÊàê</strong></p>
                        <p>ÈÄîÁªèÁ´ôÁÇπ: <span class="highlight">${route.path.length}</span> ‰∏™</p>
                        <p>Êç¢‰πòÊ¨°Êï∞: <span class="highlight">${transfers.length - 1}</span> Ê¨°</p>
                    `;
                    
                    // Êõ¥Êñ∞Êç¢‰πò‰ø°ÊÅØ
                    const transferInfo = document.getElementById('transferInfo');
                    transferInfo.innerHTML = transfers.map((transfer, index) => {
                        // Êü•ÊâæÁ∫øË∑Ø‰ø°ÊÅØÔºåÂà§Êñ≠ÊòØÂê¶‰∏∫Ê≠•Ë°åË∑ØÁ∫øË∑Ø
                        const lineInfo = appState.lines.find(line => line.name === transfer.lineName || line.id === transfer.line);
                        const isWalkingLine = lineInfo && lineInfo.lineType === 'walking';
                        
                        // Â¶ÇÊûúÊòØÊ≠•Ë°åË∑ØÁ∫øË∑ØÔºåÂÆåÂÖ®‰∏çÊòæÁ§∫Âú®Êç¢‰πò‰ø°ÊÅØÊ°Ü‰∏≠
                        if (isWalkingLine) {
                            return '';
                        } else {
                            return `
                                <div class="transfer-step">
                                    <div class="line-name">
                                        Êç¢‰πòÁ∫øË∑ØÔºö${transfer.lineName}
                                    </div>
                                    <div class="stations">
                                        ${transfer.stations.join(' ‚Üí ')}
                                    </div>
                                </div>
                            `;
                        }
                    }).join('');
                    
                    utils.showNotification(`Ë∑ØÂæÑËßÑÂàíÂÆåÊàê`);
                    
                } catch (error) {
                    utils.showNotification('Ë∑ØÂæÑËÆ°ÁÆóÈîôËØØ', 'error');
                    console.error('Ë∑ØÂæÑËÆ°ÁÆóÈîôËØØ:', error);
                }
            },

            handleZoomIn() {
                appState.mapScale = Math.min(3, appState.mapScale * 1.2);
                mapRenderer.render();
            },

            handleZoomOut() {
                appState.mapScale = Math.max(0.5, appState.mapScale * 0.8);
                mapRenderer.render();
            },

            handleResetView() {
                appState.mapScale = 1;
                appState.mapOffset = { x: 0, y: 0 };
                mapRenderer.render();
            },

            handleSaveImage() {
                try {
                    // ‰øùÂ≠òÂΩìÂâçÁöÑÂú∞ÂõæÁä∂ÊÄÅ
                    const originalScale = appState.mapScale;
                    const originalOffset = { ...appState.mapOffset };
                    
                    // Âä®ÊÄÅËÆ°ÁÆóÂÆåÊï¥Âú∞ÂõæÁöÑËåÉÂõ¥
                    let minX = Infinity, maxX = -Infinity;
                    let minY = Infinity, maxY = -Infinity;
                    
                    if (appState.stations && appState.stations.length > 0) {
                        appState.stations.forEach(station => {
                            if (station.X !== undefined && station.Y !== undefined) {
                                minX = Math.min(minX, station.X);
                                maxX = Math.max(maxX, station.X);
                                minY = Math.min(minY, station.Y);
                                maxY = Math.max(maxY, station.Y);
                            }
                        });
                    }
                    
                    // Â¶ÇÊûúÊ≤°ÊúâÊúâÊïàÊï∞ÊçÆÔºå‰ΩøÁî®ÈªòËÆ§ËåÉÂõ¥ÔºàËøô‰∏™ËåÉÂõ¥Êîπ‰∏çÂæóÔºâ
                    if (minX === Infinity) {
                        minX = -1000; maxX = 1000;
                        minY = -1000; maxY = 1000;
                    }
                    
                    // ËÆæÁΩÆÂêàÈÄÇÁöÑÁº©ÊîæÊØî‰æã‰ª•ÊòæÁ§∫ÂÆåÊï¥Âú∞Âõæ
                    const targetScale = 0.8; // Ë∞ÉÊï¥Ëøô‰∏™ÂÄº‰ª•Ëé∑ÂæóÊúÄ‰Ω≥ÊòæÁ§∫ÊïàÊûú
                    
                    // ÂàõÂª∫‰∏¥Êó∂CanvasÊù•Ê∏≤ÊüìÂÆåÊï¥Âú∞Âõæ
                    const tempCanvas = document.createElement('canvas');
                    const tempCtx = tempCanvas.getContext('2d');
                    
                    // ËÆæÁΩÆ‰∏¥Êó∂CanvasÂ∞∫ÂØ∏ÔºåÁ°Æ‰øùÂÆåÊï¥Âú∞ÂõæËÉΩÂ§üÊòæÁ§∫
                    const scale = 2; // ‰∏éworldToScreen‰∏≠ÁöÑscale‰∏ÄËá¥
                    const offsetX = 400; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetX‰∏ÄËá¥
                    const offsetY = -100; // ‰∏éworldToScreen‰∏≠ÁöÑoffsetY‰∏ÄËá¥
                    
                    // ËÆ°ÁÆóÊâÄÈúÄCanvasÂ∞∫ÂØ∏ÔºåÁ°Æ‰øùËÉΩÂÆπÁ∫≥ÂÆåÊï¥Âú∞Âõæ
                    const margin = 100; // ËæπË∑ù
                    
                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºöÊ≠£Á°ÆËÆ°ÁÆóÂú∞ÂõæÁöÑÂÆûÈôÖÊòæÁ§∫ËåÉÂõ¥
                    // Ê†πÊçÆworldToScreenÂÖ¨ÂºèÔºöscreenX = centerX + (x + offsetX) * scale * mapScale + mapOffset.x
                    // ÂΩìcenterX = canvas.width/2ÔºåmapOffset.x = 0Êó∂ÔºåÂú∞ÂõæÁöÑÂÆûÈôÖÊòæÁ§∫ËåÉÂõ¥ÊòØÔºö
                    // ‰ªé -centerX Âà∞ +centerXÔºåËÄå‰∏çÊòØ‰ªé0ÂºÄÂßã
                    
                    // ËÆ°ÁÆóÂú∞ÂõæÂú®ËΩ¨Êç¢ÂêéÁöÑÂùêÊ†áÁ≥ª‰∏≠ÁöÑÊúÄÂ§ßËåÉÂõ¥
                    const maxAbsX = Math.max(Math.abs(minX + offsetX), Math.abs(maxX + offsetX));
                    const maxAbsY = Math.max(Math.abs(minY + offsetY), Math.abs(maxY + offsetY));
                    
                    // ËÆ°ÁÆóÊâÄÈúÄÁöÑCanvasÂ∞∫ÂØ∏ÔºàËÄÉËôë‰∏≠ÂøÉÁÇπÂÅèÁßªÂêéÁöÑÂÆåÊï¥ËåÉÂõ¥Ôºâ
                    const requiredWidth = maxAbsX * 2 * scale * targetScale + margin * 2;
                    const requiredHeight = maxAbsY * 2 * scale * targetScale + margin * 2;
                    
                    // ‰ΩøÁî®È´òÂàÜËæ®Áéá‰ª•Ëé∑ÂæóÊõ¥Ê∏ÖÊô∞ÁöÑÂõæÁâá
                    const resolutionMultiplier = 3; // ÊèêÈ´òÂàÜËæ®ÁéáÂÄçÊï∞
                    tempCanvas.width = Math.max(3000, requiredWidth * resolutionMultiplier);
                    tempCanvas.height = Math.max(2250, requiredHeight * resolutionMultiplier);
                    
                    // ËÆæÁΩÆ‰∏¥Êó∂CanvasÁöÑ‰∏ä‰∏ãÊñá
                    tempCtx.fillStyle = '#ffffff';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // ‰∏¥Êó∂‰øÆÊîπappState‰ª•Ê∏≤ÊüìÂà∞‰∏¥Êó∂Canvas
                    const originalCanvas = appState.canvas;
                    const originalCtx = appState.ctx;
                    
                    appState.canvas = tempCanvas;
                    appState.ctx = tempCtx;
                    appState.mapScale = targetScale * resolutionMultiplier;
                    
                    // ËÆ°ÁÆó‰∏≠ÂøÉÁÇπÔºàCanvasÁöÑ‰∏≠ÂøÉÔºâ
                    const centerX = tempCanvas.width / 2;
                    const centerY = tempCanvas.height / 2;
                    
                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏çÈúÄË¶ÅÈ¢ùÂ§ñÁöÑÂÅèÁßªÔºåÂõ†‰∏∫worldToScreenÂáΩÊï∞Â∑≤ÁªèËÄÉËôë‰∫ÜcenterXÂíåcenterY
                    appState.mapOffset = { 
                        x: 0,
                        y: 0
                    };
                    
                    // ÂÖ≥ÈîÆ‰øÆÂ§çÔºö‰∏¥Êó∂‰øÆÊîπworldToScreenÂáΩÊï∞Ôºå‰ΩøÂÖ∂‰ΩøÁî®Âõ∫ÂÆöÁöÑ‰∏≠ÂøÉÁÇπËÆ°ÁÆó
                    const originalWorldToScreen = mapRenderer.worldToScreen;
                    mapRenderer.worldToScreen = function(x, y) {
                        const screenX = centerX + (x + offsetX) * scale * appState.mapScale + appState.mapOffset.x;
                        const screenY = centerY + (y + offsetY) * scale * appState.mapScale + appState.mapOffset.y;
                        return { x: screenX, y: screenY };
                    };
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÂÆåÊï¥Âú∞Âõæ
                    mapRenderer.clearMap();
                    
                    // Âú®‰∏¥Êó∂Canvas‰∏äËÆæÁΩÆÁôΩËâ≤ËÉåÊôØ
                    tempCtx.fillStyle = '#ffffff';
                    tempCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Ê∏≤ÊüìÊâÄÊúâÁ∫øË∑ØÂíåÁ´ôÁÇπ
                    if (appState.lines && appState.lines.length > 0) {
                        mapRenderer.displayLinesWithTurns(appState.lines);
                        mapRenderer.displayStations(appState.lines);
                        
                        // Âú®Canvas‰∏äÁªòÂà∂Á´ôÁÇπÂêçÂ≠óÔºàÁî®‰∫éÂõæÁâá‰øùÂ≠òÔºâ
                        this.drawStationNamesOnCanvas(appState.lines);
                    }
                    
                    // Âú®Canvas‰∏äÁªòÂà∂Âõæ‰æãÔºàÁî®‰∫éÂõæÁâá‰øùÂ≠òÔºâ- Âú®Ê∏≤ÊüìÂÆåÊàêÂêéÂçïÁã¨ÁªòÂà∂
                    if (appState.lines && appState.lines.length > 0) {
                        mapRenderer.drawLegendOnCanvas(tempCtx, targetScale * resolutionMultiplier);
                    }
                    
                    // ÊÅ¢Â§çÂéüÂßãÁä∂ÊÄÅ
                    appState.canvas = originalCanvas;
                    appState.ctx = originalCtx;
                    appState.mapScale = originalScale;
                    appState.mapOffset = originalOffset;
                    
                    // ÊÅ¢Â§çÂéüÂßãÁöÑworldToScreenÂáΩÊï∞
                    mapRenderer.worldToScreen = originalWorldToScreen;
                    
                    // ÈáçÊñ∞Ê∏≤ÊüìÂéüÂßãËßÜÂõæ
                    mapRenderer.render();
                    
                    // ËΩ¨Êç¢‰∏∫DataURL
                    const dataURL = tempCanvas.toDataURL('image/png');
                    
                    // ÂàõÂª∫‰∏ãËΩΩÈìæÊé•
                    const link = document.createElement('a');
                    link.download = `Jiuyuantong_${new Date().toLocaleDateString().replace(/\//g, '-')}.png`;
                    link.href = dataURL;
                    
                    // Ëß¶Âèë‰∏ãËΩΩ
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    utils.showNotification('ÂÆåÊï¥Âú∞ÂõæÂõæÁâáÂ∑≤‰øùÂ≠ò');
                } catch (error) {
                    console.error('‰øùÂ≠òÂõæÁâáÂ§±Ë¥•:', error);
                    utils.showNotification('‰øùÂ≠òÂõæÁâáÂ§±Ë¥•ÔºåËØ∑ÈáçËØï', 'error');
                }
            },
            
            drawStationNamesOnCanvas(lines) {
                const ctx = appState.ctx;
                const scale = appState.mapScale;
                
                lines.forEach(line => {
                    line.stations.forEach(station => {
                        const screenPos = mapRenderer.worldToScreen(station.X, station.Y);
                        
                        // ËÆæÁΩÆÂ≠ó‰ΩìÊ†∑ÂºèÔºàÂú®È´òÂàÜËæ®Áéá‰∏ã‰øùÊåÅÊ∏ÖÊô∞Ôºâ
                        ctx.font = `${Math.max(14, 16 * scale)}px Arial, sans-serif`;
                        ctx.fillStyle = '#000000';
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        
                        // ÁªòÂà∂Á´ôÁÇπÂêçÂ≠ó
                        ctx.fillText(station.name, screenPos.x, screenPos.y - 18 * scale);
                        
                        // Â¶ÇÊûúÊúâËã±ÊñáÂêçÂ≠óÔºå‰πüÁªòÂà∂
                        if (station.englishName && station.englishName !== station.name) {
                            ctx.font = `${Math.max(12, 14 * scale)}px Arial, sans-serif`;
                            ctx.fillStyle = '#333333';
                            ctx.fillText(station.englishName, screenPos.x, screenPos.y + 18 * scale);
                        }
                    });
                });
            }
        };

        // ÂàùÂßãÂåñÂ∫îÁî®
        document.addEventListener('DOMContentLoaded', function() {
            window.eventHandlers.init();
            
            // ËÆæÁΩÆÈªòËÆ§ÂÖâÊ†áÊ†∑Âºè
            appState.canvas.style.cursor = 'grab';
            
            // ÂàùÂßãÊ∏≤Êüì
            mapRenderer.render();
        });
    </script>
    
    <!-- ÂÜÖÂµåÂú∞ÈìÅÊï∞ÊçÆ -->
    <script>
        // Âú∞ÈìÅÁ∫øË∑ØÊï∞ÊçÆ - ‰ª•Á∫øË∑Ø‰∏∫‰∏≠ÂøÉÁöÑÂ≠òÂÇ®ÁªìÊûÑ 
        const subwayData = `lineId,lineName,color,isExpress,stationSequence
K1,K1,#53c700,true,"ÊóßÂõ≠:1,Á∫ΩÂÖãÂåóÁ´ô:2"
K2,K2,#005eff,true,"ÁëúË•ø:1,Êñ∞ÂüéÂè£:2,ÊóßÂõ≠ÈÉä(Âø´Ëàπ):3,Â§ßË•øÊ¥ãÈ≤ë:4"

ËøëË•øÂçóÁ∫ø,ËøëË•øÂçóÁ∫ø,#ffd500,false,"ÊóßÂõ≠:1,ÊóßÂõ≠ÈÉä(ÈìÅË∑Ø):2,Âä´Êé†ÂâçÂì®:3,Á∫ΩÂÖãÁ´ô:4"
ÂåóÊ°•Á∫ø,ÂåóÊ°•Á∫ø,#ff8fa4,false,"ÊóßÂõ≠:1,ÂåóÊ°•:2"

N1,N1,#E3002B,false,"Á∫ΩÂÖãÂåóÁ´ô:1,Â∑•‰∏öÂõ≠:2,Á∫ΩÂÖãÁ´ô:3"
HCLÁ∫ø,HCLÁ∫ø,#bfa15c,false,"Ê≤ôÂåóÁ´ô:1,Â∫úÈÇ∏:2,ÈòøËê®‰ºü:3"

S1,S1,#00c3ff,false,"Êñ∞ÂüéÂè£:1,‰ªôÈõ™:2,ÂçÅÂ≠óÂè£:3,Â°òÂøÉ:4"
S2,S2,#00ffaa,false,"Êñ∞ÂüéÂè£:1,Ê∏îÂú∫:2"
S3,S3,#fcba77,false,"Â∑•‰∏öÂõ≠:1,ÂçÅÂ≠óÂè£:2"
S4,S4,#ff5900,false,"ÊóßÂõ≠:1,Êñ∞ÂüéÂè£:2"
S5,S5,#b7ff00,false,"Ê∏îÂú∫:1,ÊóßÂõ≠:2"
S6,S6,#a600ff,false,"ÊóßÂõ≠ÈÉä(ÈìÅË∑Ø):1,ÂçóÊ±üÁïî:2,Ëøë‰∏úÂçó‰∏ÄÊùë:3"
S7,S7,#b700AA,false,"ÊóßÂõ≠:1,ÁüøÂ±±:2,ÂèãË∞äÈïøÂ≠òÁ∫™ÂøµÁ¢ë:3,ÂçóÊ±üÁïî:4"
S9,S9,#92b0a8,false,"ÂçÅÂ≠óÂè£:1,ÂåóÊ°•Ê≥∞Âä†:2,Ê≤ôÂåó‰∏úÁ´ô:3"


`;

        // Á´ôÁÇπÂùêÊ†á‰ø°ÊÅØÔºàÂçïÁã¨Â≠òÂÇ®Ôºâ
        const stationCoordinates = `name,englishName,X,Y,transfer,transferLines,transferPlatforms,isMajor,management
ÊóßÂõ≠,Jiuyuan,-137,66,true,"K1,ËøëË•øÂçóÁ∫ø,ÂåóÊ°•Á∫ø,S2,S4,S7","3F,Âú∞‰∏ã,2F,2F,2F,2F",true,
ÊóßÂõ≠ÈÉä(Âø´Ëàπ),Jiuyuanjiao (Express),-247,146,true,,,false,
ÊóßÂõ≠ÈÉä(ÈìÅË∑Ø),Jiuyuanjiao (Railway),-222,226,true,"ËøëË•øÂçóÁ∫ø,S6","-1F,-2F",false,
ÁüøÂ±±,Kuangshan,-60,62,false,,,false,
ÂèãË∞äÈïøÂ≠òÁ∫™ÂøµÁ¢ë,Monument to Eternal Friendship,-57,118,false,,,false,

Êñ∞ÂüéÂè£,Xinchengkou,-238,18,true,"K2,S1","2F,1F",true,
‰ªôÈõ™,Xianxue,-284,16,false,,,false,
ÂçÅÂ≠óÂè£,Shizikou,-330,16,true,"S1,S3,S9","Á´ôÂè∞ 1 ,Á´ôÂè∞ 2 ,Á´ôÂè∞ 3",true,
Â°òÂøÉ,Lake Center,-377,16,false,,,false,
Ê∏îÂú∫,Yuchang,-206,66,true,"S2,S5","1F,2F",false,
Ê≤ôÂåó‰∏úÁ´ô,Shabei East Station,-325,-490,false,,,false,
Ê≤ôÂåóÁ´ô,Shabei Station,-522,-550,true,"HCL","",false,

Â∑•‰∏öÂõ≠,Gongyeyuan,-814,255,true,"N1,S3","A,B",false,Â∫üÂºÉÂå∫Âüü
Á∫ΩÂÖãÂåóÁ´ô,Niuke North Station,-963,93,true,"K1,N1","Âú∞‰∏ä,Âú∞‰∏ã",false,Â∫üÂºÉÂå∫Âüü
Âä´Êé†ÂâçÂì®,Jielueqianshao,-630,233,false,,,false,Â∫üÂºÉÂå∫Âüü
Á∫ΩÂÖãÁ´ô,Niuke Station,-800,333,true,"ËøëË•øÂçóÁ∫ø,N1","Âú∞‰∏ä,Âú∞‰∏ã",false,Â∫üÂºÉÂå∫Âüü
ÈòøËê®‰ºü,Asawei,-900,-370,false,,,false,Â∫üÂºÉÂå∫Âüü
Â∫úÈÇ∏,Fudi,-757,264,true,,,false,Â∫üÂºÉÂå∫Âüü

ÂåóÊ°•,Beiqiao,-136,-224,false,,,false,
ÂåóÊ°•Ê≥∞Âä†,Beiqiao Taiga,-330,-224,false,,,false,
ÁëúË•ø,Yuxi,-247,-231,false,,,false,

ÂçóÊ±üÁïî,Nanjiangpan,-42,226,true,"S6,S7","Á´ôÂè∞ 1,Á´ôÂè∞ 2",false,
Ëøë‰∏úÂçó‰∏ÄÊùë,Jindongnan I,125,226,false,,,false,

Â§ßË•øÊ¥ãÈ≤ë,Daxiyanggui,-261,456,false,,,false,

`;
    </script>

    <!-- ÂÜÖÂµåÊ≠•Ë°åË∑ØÊï∞ÊçÆ -->
    <script>
        // Ê≠•Ë°åË∑ØÊï∞ÊçÆ - Ê≠•Ë°åË∑ØÁ∫øË∑ØÁ±ªÂûã 
        const walkingData = `color,isExpress,lineType,stationSequence
#808080,false,walking,"ÊóßÂõ≠ÈÉä(ÈìÅË∑Ø):1,ÊóßÂõ≠ÈÉä(Âø´Ëàπ):2"
#808080,false,walking,"Â∫úÈÇ∏:1,Â∑•‰∏öÂõ≠:2"
#808080,false,walking,"ÂåóÊ°•:1,ÁëúË•ø:2,ÂåóÊ°•Ê≥∞Âä†:3"
`;
    </script>
    <script>
        // ËäÇÁÇπÊï∞ÊçÆ xÔºåy‰∏∫ÂùêÊ†á line‰∏∫Á∫øË∑Øid ËäÇÁÇπÂú®Á∫øË∑Ø‰∏äÁöÑstn1Âíåstn2‰∏§‰∏™Á´ô‰πãÈó¥
        const nodeData = `x,y,line,stn1,stn2
        
`;
    </script>
</body>
</html>